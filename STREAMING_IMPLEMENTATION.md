# AI è¯­éŸ³åŠ©æ‰‹æµå¼è¾“å‡ºå®ç°å®Œæˆ

## å®ç°åŠŸèƒ½

### 1. è¯­éŸ³è¯†åˆ«ç«‹å³æ˜¾ç¤º
- å½•éŸ³ç»“æŸåç«‹å³è°ƒç”¨ `/transcribe` æ¥å£
- è¯†åˆ«ç»“æœé©¬ä¸Šæ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢ï¼ˆæ ¼å¼ï¼šğŸ¤ "è¯†åˆ«çš„æ–‡å­—"ï¼‰
- ç”¨æˆ·æ— éœ€ç­‰å¾… AI å›å¤å°±èƒ½çœ‹åˆ°è‡ªå·±è¯´äº†ä»€ä¹ˆ

### 2. AI å›å¤æµå¼è¾“å‡ºï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰
- ä½¿ç”¨ Server-Sent Events (SSE) å®ç°æµå¼ä¼ è¾“
- AI å›å¤é€å­—æ˜¾ç¤ºï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å…¨éƒ¨å‡ºç°
- æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒå’Œå®æ—¶åé¦ˆ

## æŠ€æœ¯å®ç°

### åç«¯ (ai_voice_service_offline.py)

#### æ–°å¢æ¥å£ 1: `/transcribe`
```python
@app.post("/transcribe")
async def transcribe_only(audio: UploadFile = File(...)):
    """ä»…è¯­éŸ³è¯†åˆ«æ¥å£ï¼ˆå¿«é€Ÿè¿”å›è¯†åˆ«æ–‡æœ¬ï¼‰"""
```
- åŠŸèƒ½ï¼šåªåšè¯­éŸ³è¯†åˆ«ï¼Œä¸è°ƒç”¨ LLM
- è¿”å›ï¼š`{"text": "è¯†åˆ«çš„æ–‡å­—"}`
- ä¼˜ç‚¹ï¼šå¿«é€Ÿå“åº”ï¼Œç«‹å³æ˜¾ç¤ºè¯†åˆ«ç»“æœ

#### æ–°å¢æ¥å£ 2: `/chat-stream`
```python
@app.post("/chat-stream")
async def chat_stream(text: str = Form(...)):
    """æµå¼å¯¹è¯æ¥å£ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰"""
```
- åŠŸèƒ½ï¼šä½¿ç”¨ Ollama æµå¼ APIï¼Œé€å­—è¿”å› AI å›å¤
- è¿”å›æ ¼å¼ï¼šServer-Sent Events (SSE)
  - æ–‡æœ¬å—ï¼š`data: {"text": "å­—"}\n\n`
  - å®Œæˆæ ‡å¿—ï¼š`data: {"audio": "base64éŸ³é¢‘", "done": true}\n\n`
- å…³é”®æ”¹è¿›ï¼šç´¯ç§¯å®Œæ•´æ–‡æœ¬åå†ç”Ÿæˆè¯­éŸ³ï¼ˆé¿å…åªè¯»å–æœ€åä¸€ä¸ªå­—ç¬¦ï¼‰

#### ä¿ç•™æ¥å£: `/chat`
- ä¿æŒå‘åå…¼å®¹
- ç”¨äºéæµå¼åœºæ™¯

### å‰ç«¯ (main/templates/ai_health_advisor.html)

#### æ–°å¢å‡½æ•°: `sendTextStream(text)`
```javascript
async function sendTextStream(text) {
    // 1. åˆ›å»ºæ¶ˆæ¯å®¹å™¨
    // 2. ä½¿ç”¨ fetch + ReadableStream è¯»å– SSE
    // 3. é€å­—æ›´æ–°æ¶ˆæ¯å†…å®¹
    // 4. æ”¶åˆ°éŸ³é¢‘åæ’­æ”¾
}
```

#### ä¿®æ”¹å‡½æ•°: `sendAudio(audioBlob)`
```javascript
async function sendAudio(audioBlob) {
    // ç¬¬ä¸€æ­¥ï¼šè°ƒç”¨ /transcribe è¯†åˆ«è¯­éŸ³
    // ç¬¬äºŒæ­¥ï¼šç«‹å³æ˜¾ç¤ºè¯†åˆ«ç»“æœ
    // ç¬¬ä¸‰æ­¥ï¼šè°ƒç”¨ sendTextStream() æµå¼è·å– AI å›å¤
}
```

#### ä¿®æ”¹å‡½æ•°: `sendText(text)`
```javascript
async function sendText(text) {
    // æ–‡å­—è¾“å…¥ä¹Ÿä½¿ç”¨æµå¼è¾“å‡º
    await sendTextStream(text);
}
```

## ç”¨æˆ·ä½“éªŒæµç¨‹

### è¯­éŸ³è¾“å…¥æµç¨‹
1. ç”¨æˆ·ç‚¹å‡»éº¦å…‹é£æŒ‰é’®å¼€å§‹å½•éŸ³
2. ç”¨æˆ·è¯´è¯ï¼ˆæ˜¾ç¤º"æ­£åœ¨å½•éŸ³..."ï¼‰
3. ç”¨æˆ·ç‚¹å‡»åœæ­¢å½•éŸ³
4. **ç«‹å³æ˜¾ç¤º**ï¼šğŸ¤ "è¯†åˆ«çš„æ–‡å­—"ï¼ˆæ— éœ€ç­‰å¾…ï¼‰
5. æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨ï¼ˆä¸‰ä¸ªè·³åŠ¨çš„ç‚¹ï¼‰
6. AI å›å¤**é€å­—æ˜¾ç¤º**ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰
7. å›å¤å®Œæˆåè‡ªåŠ¨æ’­æ”¾è¯­éŸ³

### æ–‡å­—è¾“å…¥æµç¨‹
1. ç”¨æˆ·è¾“å…¥æ–‡å­—å¹¶å‘é€
2. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
3. æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
4. AI å›å¤**é€å­—æ˜¾ç¤º**ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰
5. å›å¤å®Œæˆåè‡ªåŠ¨æ’­æ”¾è¯­éŸ³

## å…³é”®ä¼˜åŒ–ç‚¹

### 1. åç«¯ç´¯ç§¯æ–‡æœ¬
```python
full_text = ""  # ç´¯ç§¯å®Œæ•´æ–‡æœ¬
async for line in response.aiter_lines():
    data = json.loads(line)
    if "response" in data:
        chunk_text = data["response"]
        full_text += chunk_text  # ç´¯ç§¯
        yield f"data: {json.dumps({'text': chunk_text})}\n\n"
    
    if data.get("done", False):
        # ä½¿ç”¨å®Œæ•´æ–‡æœ¬ç”Ÿæˆè¯­éŸ³
        audio_bytes = await text_to_speech(full_text)
```

### 2. å‰ç«¯æµå¼è¯»å–
```javascript
const reader = response.body.getReader();
const decoder = new TextDecoder();
let fullText = '';

while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    
    const chunk = decoder.decode(value, { stream: true });
    // è§£æ SSE æ ¼å¼
    // é€å­—æ›´æ–°ç•Œé¢
}
```

## æµ‹è¯•å»ºè®®

1. **è¯­éŸ³è¯†åˆ«æµ‹è¯•**
   - å½•åˆ¶çŸ­è¯­éŸ³ï¼ˆ3-5ç§’ï¼‰
   - æ£€æŸ¥è¯†åˆ«ç»“æœæ˜¯å¦ç«‹å³æ˜¾ç¤º
   - æ£€æŸ¥è¯†åˆ«å‡†ç¡®åº¦

2. **æµå¼è¾“å‡ºæµ‹è¯•**
   - å‘é€æ–‡å­—æ¶ˆæ¯
   - è§‚å¯Ÿ AI å›å¤æ˜¯å¦é€å­—æ˜¾ç¤º
   - æ£€æŸ¥æ‰“å­—é€Ÿåº¦æ˜¯å¦æµç•…

3. **è¯­éŸ³æ’­æ”¾æµ‹è¯•**
   - ç¡®è®¤æµå¼è¾“å‡ºå®Œæˆåè‡ªåŠ¨æ’­æ”¾è¯­éŸ³
   - æ£€æŸ¥è¯­éŸ³å†…å®¹æ˜¯å¦å®Œæ•´

4. **é”™è¯¯å¤„ç†æµ‹è¯•**
   - æ–­ç½‘æƒ…å†µ
   - æœåŠ¡å™¨é”™è¯¯
   - éŸ³é¢‘æ ¼å¼é”™è¯¯

## é…ç½®è¯´æ˜

### API ç«¯ç‚¹
```javascript
const TRANSCRIBE_URL = 'http://127.0.0.1:8001/transcribe';
const CHAT_STREAM_URL = 'http://127.0.0.1:8001/chat-stream';
```

### Ollama é…ç½®
```python
OLLAMA_HOST = "http://172.16.4.181:11434"
OLLAMA_MODEL = "qwen2.5:7b"
```

## å¯åŠ¨æœåŠ¡

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
.venv\Scripts\activate

# å¯åŠ¨è¯­éŸ³æœåŠ¡
python ai_voice_service_offline.py

# æˆ–ä½¿ç”¨æ‰¹å¤„ç†æ–‡ä»¶
start_offline.bat
```

æœåŠ¡å°†è¿è¡Œåœ¨ `http://0.0.0.0:8001`

## ä¾èµ–åº“

- `fastapi` - Web æ¡†æ¶
- `uvicorn` - ASGI æœåŠ¡å™¨
- `httpx` - HTTP å®¢æˆ·ç«¯ï¼ˆæ”¯æŒæµå¼ï¼‰
- `openai-whisper` - è¯­éŸ³è¯†åˆ«
- `edge-tts` - ä¸­æ–‡è¯­éŸ³åˆæˆ
- `ffmpeg` - éŸ³é¢‘å¤„ç†ï¼ˆéœ€è¦ç³»ç»Ÿå®‰è£…ï¼‰

## å®ŒæˆçŠ¶æ€

âœ… åç«¯æµå¼æ¥å£å®ç°
âœ… å‰ç«¯æµå¼æ˜¾ç¤ºå®ç°
âœ… è¯­éŸ³è¯†åˆ«ç«‹å³æ˜¾ç¤º
âœ… æ‰“å­—æœºæ•ˆæœ
âœ… éŸ³é¢‘æ’­æ”¾
âœ… é”™è¯¯å¤„ç†

æ‰€æœ‰åŠŸèƒ½å·²å®Œæ•´å®ç°å¹¶å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼
