# 智慧食堂点餐-机械臂任务控制系统

## 系统概述
本系统实现了从用户点餐到机械臂自动配餐的完整流程控制，包含菜品分类、排序、YOLO检测和机械臂任务执行等功能。

## 核心功能

### 1. 菜品分类与排序
- **肉类**: 红烧排骨、花菜牛腩、烤鸭
- **素菜**: 清炒黑木耳、清炒莲藕
- **主食**: 米饭

执行顺序：肉类 → 素菜 → 主食（保持用户原始点选顺序）

### 2. 任务ID映射
| 菜品名称 | 机械臂任务ID |
|----------|-------------|
| 米饭     | 10001       |
| 红烧排骨 | 10002       |
| 花菜牛腩 | 10003       |
| 烤鸭     | 10004       |
| 清炒黑木耳 | 10005     |
| 清炒莲藕 | 10006       |

### 3. YOLOv5检测集成
- 每道菜品执行前进行YOLO检测
- 检测超时时间：5秒
- 检测失败时输出提示："没有找到[菜品名称]请及时补货"
- 未检测到菜品时跳过该任务

## 工作流程

### 阶段1：记录点餐
1. 用户在前端选择菜品
2. 系统调用/submit-order/接口保存订单
3. 订单信息存储在UserInputDishTable中

### 阶段2：执行任务
1. 用户点击"取餐"按钮
2. 前端调用/execute_order_tasks/接口
3. 系统执行以下步骤：
   - 获取订单菜品列表
   - 按分类排序菜品
   - 对每个菜品进行YOLO检测
   - 检测通过后执行对应机械臂任务
   - 记录执行结果

## API接口

### 提交订单
```
POST /submit-order/
Content-Type: application/json

{
    "items": [
        {"id": 1, "name": "红烧排骨"},
        {"id": 2, "name": "清炒莲藕"}
    ]
}
```

### 执行订单任务
```
GET /execute_order_tasks/?order_id=123
```

### 单个任务执行
```
GET /execute_task_one/?scene_id=10002
```

## 配置说明

### 修改任务ID映射
编辑 `dish_task_config.py` 文件：
```python
DISH_TASK_MAPPING = {
    '新菜品': '新任务ID',
    # ...
}
```

### 修改菜品分类
```python
DISH_CATEGORIES = {
    '新分类': ['菜品1', '菜品2'],
    # ...
}
```

### 修改机械臂配置
```python
ROBOT_CONFIG = {
    'ip': '192.168.101.147',  # 机械臂IP地址
    'timeout': 5,            # 检测超时时间
    'detection_success_rate': 0.8  # 检测成功率
}
```

## 部署说明

### 1. 启动YOLOv5检测服务
```bash
python yolov5_stream.py
```
服务将在 http://localhost:5000 启动

### 2. 启动Django服务
```bash
python manage.py runserver
```

### 3. 测试流程
1. 访问 http://localhost:8000
2. 选择菜品并提交订单
3. 在订单状态页面点击"取餐"
4. 观察机械臂执行任务

## 故障排除

### YOLO检测失败
- 检查yolov5_stream.py是否正常运行
- 确认摄像头连接正常
- 检查菜品是否在检测范围内

### 机械臂连接失败
- 确认机械臂IP地址正确
- 检查网络连接
- 确认机械臂已开机并初始化

### 任务执行失败
- 检查任务ID是否正确
- 确认机械臂场景配置
- 查看Django日志获取详细错误信息

## 扩展建议

### 添加新菜品
1. 在DISH_TASK_MAPPING中添加映射
2. 在DISH_CATEGORIES中分类
3. 更新YOLO模型以识别新菜品
4. 在数据库中添加新菜品信息

### 优化检测
- 集成实际的YOLOv5检测API
- 添加检测置信度阈值
- 实现多摄像头支持
- 添加菜品位置跟踪

### 增强用户体验
- 添加实时任务进度显示
- 实现WebSocket实时通信
- 添加语音播报功能
- 支持订单状态推送