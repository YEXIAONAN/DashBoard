# 机械臂取餐系统使用文档

## 📖 目录
- [系统概述](#系统概述)
- [功能特性](#功能特性)
- [API 接口说明](#api-接口说明)
- [使用示例](#使用示例)
- [配置说明](#配置说明)
- [故障排查](#故障排查)
- [注意事项](#注意事项)

---

## 系统概述

本系统是一个智能餐饮机械臂取餐系统，集成了乐白（Lebai）机械臂和 YOLOv11 视觉识别技术，能够自动完成菜品识别、抓取和放置的全流程操作。

### 核心组件
- **机械臂：** 乐白（Lebai）机器人 - IP: 172.16.4.78
- **视觉识别：** YOLOv11 检测服务 - IP: 172.16.4.223:5000
- **后端服务：** Django REST API
- **数据库：** MySQL（订单和菜品数据）

---

## 功能特性

### 1. 智能菜品分类
系统自动将菜品分为三类，并按优先级排序：
- **肉类** → **素菜** → **主食**

### 2. 双模式运行
#### 模式 A：直接执行模式（默认）⭐
- 跳过 YOLO 视觉检测
- 直接执行预设任务
- 速度快，适用于调试、测试或菜品位置固定的场景
- **这是默认模式**

#### 模式 B：智能检测模式
- 使用 YOLOv11 视觉识别
- 自动检测菜品位置
- 确认菜品存在后再执行抓取
- 需要明确指定 `use_yolo=true` 才会启用

### 3. 完整的取餐流程
1. 初始化机械臂
2. 移动到菜品识别区域
3. 逐个检测/执行菜品任务
4. 根据菜品分类执行放置操作
5. 返回安全位置

---

## API 接口说明

### 1. 启动取餐流程
**接口地址：** `/api/start_pickup_process`  
**请求方法：** `GET`  
**功能说明：** 根据订单ID启动完整的取餐流程

#### 请求参数
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| order_id | string | 是 | - | 订单ID |
| use_yolo | string | 否 | false | 是否使用YOLO检测<br>`true/1/yes/on` = 使用检测<br>其他值或不传 = 跳过检测 |

#### 返回示例
```json
{
    "status": "success",
    "message": "取餐流程已开始执行（跳过YOLO检测）",
    "use_yolo": false
}
```

#### 错误返回
```json
{
    "status": "error",
    "message": "订单ID不能为空"
}
```

---

### 2. 执行订单任务
**接口地址：** `/api/execute_order_tasks`  
**请求方法：** `GET`  
**功能说明：** 执行指定订单的所有菜品任务

#### 请求参数
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| order_id | string | 是 | - | 订单ID |
| use_yolo | string | 否 | false | 是否使用YOLO检测 |

#### 返回示例
```json
{
    "status": "success",
    "message": "任务已开始执行（跳过YOLO检测）",
    "use_yolo": false
}
```

---

### 3. 执行单个场景任务
**接口地址：** `/api/execute_task_one`  
**请求方法：** `GET`  
**功能说明：** 执行指定的机械臂场景任务

#### 请求参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| scene_id | string | 是 | 场景任务ID（如：1001, 1002等） |

#### 返回示例
```text
成功
```

---

## 使用示例

### 示例 1：快速执行模式（默认，跳过 YOLO）⭐

```bash
# 方式 1：不传参数（默认跳过YOLO）
curl "http://localhost:8000/api/start_pickup_process?order_id=20260129001"

# 方式 2：明确指定跳过YOLO
curl "http://localhost:8000/api/start_pickup_process?order_id=20260129001&use_yolo=false"
```

**执行流程：**
1. ✅ 初始化机械臂
2. ✅ 移动到识别区域
3. ⏭️ **跳过 YOLO 检测**
4. ✅ 直接执行预设任务
5. ✅ 根据分类放置菜品
6. ✅ 返回安全位置

**适用场景：**
- 🚀 日常快速取餐
- 🔧 调试机械臂动作
- 🧪 测试任务流程
- 🎯 菜品位置固定，无需检测

---

### 示例 2：智能检测模式（需要明确启用 YOLO）

```bash
# 明确指定使用YOLO检测
curl "http://localhost:8000/api/start_pickup_process?order_id=20260129001&use_yolo=true"

# 或使用其他表示"是"的值
curl "http://localhost:8000/api/start_pickup_process?order_id=20260129001&use_yolo=1"
curl "http://localhost:8000/api/start_pickup_process?order_id=20260129001&use_yolo=yes"
```

**执行流程：**
1. ✅ 初始化机械臂
2. ✅ 移动到识别区域
3. ✅ **YOLO 检测菜品位置**
4. ✅ 确认检测到菜品后执行抓取
5. ✅ 根据分类放置菜品
6. ✅ 返回安全位置

**适用场景：**
- 🎯 菜品位置不固定
- ✅ 需要确认菜品存在
- 🔍 需要精确定位

---

### 示例 3：前端 JavaScript 调用（更新）

```javascript
// 默认模式：跳过 YOLO 检测
async function startPickupFast(orderId) {
    try {
        const response = await fetch(
            `/api/start_pickup_process?order_id=${orderId}`
        );
        const result = await response.json();
        console.log('取餐流程已启动（快速模式）:', result);
    } catch (error) {
        console.error('启动失败:', error);
    }
}

// 智能检测模式：使用 YOLO
async function startPickupWithYolo(orderId) {
    try {
        const response = await fetch(
            `/api/start_pickup_process?order_id=${orderId}&use_yolo=true`
        );
        const result = await response.json();
        console.log('取餐流程已启动（智能检测）:', result);
    } catch (error) {
        console.error('启动失败:', error);
    }
}

// 调用示例
startPickupFast('20260129001');  // 默认快速模式
startPickupWithYolo('20260129001');  // 智能检测模式
```

```bash
# 执行场景 1001（示例：抓取烤鸭）
curl "http://localhost:8000/api/execute_task_one?scene_id=1001"

# 执行场景 1002（示例：抓取葱爆羊肉）
curl "http://localhost:8000/api/execute_task_one?scene_id=1002"
```

---

### 示例 4：执行单个场景任务

### 1. 菜品任务映射配置
**文件位置：** `dish_task_config.py`

```python
# 菜品到任务ID的映射
DISH_TASK_MAPPING = {
    '烤鸭': '1001',
    '葱爆羊肉': '1002',
    '清炒莲藕': '1003',
    '花菜牛腩': '1004',
    '米饭': '1005',
    # ... 更多菜品
}

# 菜品分类
DISH_CATEGORIES = {
    '肉类': ['烤鸭', '葱爆羊肉', '花菜牛腩'],
    '素菜': ['清炒莲藕', '蒜蓉西兰花'],
    '主食': ['米饭', '馒头']
}

# YOLO 类别映射
YOLO_CLASS_MAPPING = {
    '烤鸭': 'roast_duck',
    '葱爆羊肉': 'lamb',
    '米饭': 'rice',
    # ... 更多映射
}
```

---

### 2. 机械臂配置
**文件位置：** `main/api.py`

```python
# 机械臂IP地址
robot_ip = "172.16.4.78"

# YOLO服务地址
yolo_url = "http://172.16.4.223:5000/detect"

# 运动参数
a = 3      # 关节加速度 (rad/s²)
v = 0.5    # 关节速度 (rad/s)
t = 0      # 运动时间 (s)
r = 0.5    # 交融半径 (m)
```

---

### 3. 关键位置坐标

#### 菜品识别区域
```python
detection_pose = [
    -2.7816824112321243,
    -1.653727163139964,
    -1.4043594113093043,
    -4.244045471083355,
    -1.390457710419091,
    0.3760170406304678
]
```

#### 肉类放置位置
```python
meat_placement_pose = [
    -1.082798688648777,
    -2.1748012620248676,
    -1.989956577084648,
    -2.281125305385191,
    -0.9109928404055851,
    0.13997574689456477
]
```

#### 素菜放置位置
```python
vegetable_placement_pose = [
    -1.4868108786581578,
    -2.1268643624034413,
    -1.9606191945163352,
    -2.447658094670026,
    -1.2613157028389683,
    0.0466905402312692
]
```

#### 主食放置位置
```python
staple_placement_pose = [
    -1.0432986833607216,
    -1.9819031779482483,
    -2.423881392457799,
    -2.12849421699057,
    -0.8266238970718749,
    0.1564660403643354
]
```

---

## 故障排查

### 问题 1：机械臂连接失败
**错误信息：** `尝试连接机器人 172.16.4.78... 连接失败`

**解决方案：**
1. 检查机械臂电源是否开启
2. 检查网络连接：`ping 172.16.4.78`
3. 确认机械臂 IP 地址是否正确
4. 检查防火墙设置

---

### 问题 2：YOLO 检测服务不可用
**错误信息：** `连接YOLO服务失败`

**解决方案：**
1. 检查 YOLO 服务是否运行：
   ```bash
   curl http://172.16.4.223:5000/detect
   ```
2. 如果服务不可用，使用跳过检测模式：
   ```bash
   curl "http://localhost:8000/api/start_pickup_process?order_id=xxx&use_yolo=false"
   ```

---

### 问题 3：夹爪初始化失败
**错误信息：** `夹爪初始化失败`

**解决方案：**
1. 检查夹爪连接
2. 手动初始化夹爪：
   ```python
   lebai.init_claw()
   ```
3. 检查夹爪状态：
   ```python
   claw_status = lebai.get_claw()
   print(claw_status)
   ```

---

### 问题 4：菜品未找到
**错误信息：** `没有找到{dish_name}，请及时补货`

**解决方案：**
1. 检查菜品是否在识别区域内
2. 调整摄像头角度和光线
3. 确认 YOLO 模型已训练该菜品
4. 使用跳过检测模式进行测试

---

### 问题 5：运动状态异常
**错误信息：** `移动到xxx位置失败，运动状态: xxx`

**解决方案：**
1. 检查机械臂是否处于急停状态：
   ```python
   print(lebai.get_estop_reason())
   ```
2. 重启机械臂系统：
   ```python
   lebai.start_sys()
   ```
3. 检查目标位姿是否在工作空间内
4. 检查是否有碰撞或障碍物

---

## 注意事项

### ⚠️ 安全注意事项
1. **急停按钮：** 确保急停按钮随时可用
2. **工作区域：** 保持机械臂工作区域无人员和障碍物
3. **运动速度：** 调试时使用较低的速度参数
4. **夹爪力度：** 根据菜品类型调整夹爪力度，避免损坏食物

### 🔧 操作建议
1. **日常使用：** 默认快速模式即可，无需额外配置
2. **需要检测：** 当菜品位置不固定时，添加 `use_yolo=true` 参数
3. **调试模式：** 使用单个场景任务接口测试特定动作
4. **定期维护：** 定期检查夹爪、关节和传感器状态

### 📊 性能优化
1. **并发控制：** 系统使用线程执行任务，避免阻塞请求
2. **超时设置：** YOLO 检测默认超时 5 秒，可根据需要调整
3. **重试机制：** YOLO 检测失败会自动重试，间隔 0.5 秒

### 🔄 版本兼容性
- **Django：** 3.x+
- **Python：** 3.8+
- **Lebai SDK：** 最新版本
- **YOLOv11：** 自定义训练模型

---

## 附录

### A. 完整的 API 端点列表
| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/start_pickup_process` | GET | 启动取餐流程 |
| `/api/execute_order_tasks` | GET | 执行订单任务 |
| `/api/execute_task_one` | GET | 执行单个场景 |

### B. 菜品分类优先级
1. **肉类**（最先执行）
   - 烤鸭、葱爆羊肉、花菜牛腩等
2. **素菜**（其次执行）
   - 清炒莲藕、蒜蓉西兰花等
3. **主食**（最后执行）
   - 米饭、馒头等

### C. 常用命令速查
```bash
# 启动取餐（默认跳过YOLO）
curl "http://localhost:8000/api/start_pickup_process?order_id=xxx"

# 启动取餐（使用YOLO）
curl "http://localhost:8000/api/start_pickup_process?order_id=xxx&use_yolo=true"

# 执行单个场景
curl "http://localhost:8000/api/execute_task_one?scene_id=1001"

# 测试YOLO服务
curl "http://172.16.4.223:5000/detect?class=roast_duck"

# 测试机械臂连接
ping 172.16.4.78
```

---

## 更新日志

### v2.1.0 (2026-01-29)
- 🔄 **重要变更：** 默认模式改为跳过 YOLO 检测（快速模式）
- ✨ 新增：需要明确指定 `use_yolo=true` 才会启用 YOLO 检测
- 📝 文档：更新所有示例和说明

### v2.0.0 (2026-01-29)
- ✨ 新增：支持跳过 YOLO 检测的直接执行模式
- ✨ 新增：`use_yolo` 参数控制检测模式
- 🔧 优化：改进错误处理和日志输出
- 📝 文档：完善 API 文档和使用说明

### v1.0.0 (2026-01-01)
- 🎉 初始版本发布
- ✅ 支持 YOLO 视觉检测
- ✅ 支持菜品分类和排序
- ✅ 完整的取餐流程

---

## 技术支持

如有问题或建议，请联系技术团队。

**文档版本：** v2.1.0  
**最后更新：** 2026-01-29  
**维护团队：** 智慧餐饮开发组
