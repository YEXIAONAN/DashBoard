# 🔄 重启服务说明

## 已添加的改进

✅ **自动重试机制** - 遇到 502 错误时自动重试 3 次  
✅ **更好的错误提示** - 用户会看到"正在重试"的提示  
✅ **更长的超时时间** - 从 60 秒增加到 120 秒  
✅ **智能等待** - 每次重试之间等待 1 秒  

## 如何重启服务

### 方法 1: 在当前终端

1. 按 `Ctrl + C` 停止当前服务
2. 运行: `start_hybrid.bat`

### 方法 2: 直接运行

```bash
cd voice_service
..\.venv\Scripts\python.exe ai_voice_service_hybrid.py
```

## 改进说明

### 1. 非流式对话 (`/chat`)

- 自动重试 3 次
- 每次重试间隔 1 秒
- 超时时间: 120 秒

### 2. 流式对话 (`/chat-stream`)

- 自动重试 3 次
- 用户会看到重试提示
- 每次重试间隔 1 秒
- 超时时间: 120 秒

### 3. 错误处理

- **502 错误**: 自动重试
- **其他错误**: 友好的错误提示
- **超时**: 增加到 120 秒

## 为什么会出现 502 错误？

可能的原因：

1. **Ollama 服务负载高** - 正在处理其他请求
2. **网络延迟** - 172.16.4.181 服务器响应慢
3. **模型加载** - 首次请求时模型正在加载

## 测试重试功能

重启服务后，再次尝试发送消息。如果遇到 502 错误：

1. 服务会自动重试（最多 3 次）
2. 你会在前端看到"正在重试"的提示
3. 大多数情况下，重试会成功

## 如果问题持续

如果 502 错误持续出现，可能需要：

1. **检查 Ollama 服务状态**:
   ```bash
   curl http://172.16.4.181:11434/api/tags
   ```

2. **重启 Ollama 服务** (在 172.16.4.181 服务器上)

3. **检查网络连接**:
   ```bash
   ping 172.16.4.181
   ```

---

**更新时间**: 2026-01-31  
**版本**: 1.1.0  
**改进**: 添加自动重试机制
