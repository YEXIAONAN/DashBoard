<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AIå¥åº·é¡¾é—® - æ™ºèƒ½åŠ©æ‰‹</title>
     <link rel="stylesheet" href="../static/css/all.min.css">
     <script src="../static/js/marked.min.js"></script>
    <style>
        /* ===== é¡¶éƒ¨æ æ ·å¼ ===== */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-deep), var(--primary-dark));
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
            box-shadow: var(--shadow-card);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            backdrop-filter: blur(10px);
        }

        .header-title {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-icon {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .header-icon:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
            transition: all 0.3s ease;
        }

        /* ===== æ·±è“ä¸“ä¸šä¸»é¢˜é…è‰²æ–¹æ¡ˆ ===== */
        :root {
            --primary-deep: #1a5f9e;
            --primary-dark: #0d3a6b;
            --primary-light: #2c72b5;
            --secondary: #2c3e50;
            --surface: #ffffff;
            --surface-soft: #f8fafc;
            --surface-hover: #eef5fc;
            --text-primary: #2c3e50;
            --text-secondary: #546e7a;
            --text-muted: #78909c;
            --accent: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --error: #e74c3c;
            --shadow-soft: 0 2px 8px rgba(26, 95, 158, 0.08);
            --shadow-card: 0 4px 16px rgba(26, 95, 158, 0.12);
            --shadow-hover: 0 8px 24px rgba(26, 95, 158, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* å…è®¸æ–‡æœ¬é€‰æ‹©çš„å…ƒç´  */
        .text-input,
        .message,
        input[type="text"],
        input[type="password"] {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            -webkit-touch-callout: default;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            background: linear-gradient(145deg, #eef5fc 0%, #e6f2ff 100%);
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.6;
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }



        

        /* ===== ä¸»å®¹å™¨æ ·å¼ ===== */
        .container {
            width: 100%;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            background: transparent;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding-top: 60px; /* æ·»åŠ é¡¶éƒ¨å†…è¾¹è·ï¼Œé¿å…è¢«é¡¶éƒ¨æ æŒ¡ä½ */
            padding-bottom: 70px; /* æ·»åŠ åº•éƒ¨å†…è¾¹è·ï¼Œé¿å…è¢«åº•éƒ¨å¯¼èˆªæ æŒ¡ä½ */
            animation: fadeIn 0.8s ease forwards;
        }

        /* ===== AIå¯¹è¯åŒºåŸŸæ ·å¼ ===== */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin: 15px;
            background: var(--surface);
            border-radius: 20px;
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(26, 95, 158, 0.08);
            background-image: linear-gradient(to bottom right, var(--surface), var(--surface-soft));
            overflow: hidden;
            min-height: 0; /* ç¡®ä¿flexå­å…ƒç´ å¯ä»¥æ”¶ç¼© */
            animation: fadeIn 0.6s ease forwards;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid rgba(26, 95, 158, 0.08);
            background: var(--surface-soft);
        }

        .chat-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-deep);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--error);
        }

        .status-dot.connected {
            background: var(--success);
        }

        .status-dot.connecting {
            background: var(--warning);
            animation: pulse 1.5s infinite;
        }

        /* ===== å¯¹è¯åŒºåŸŸæ ·å¼ ===== */
        .conversation-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 0; /* ç¡®ä¿å¯ä»¥æ”¶ç¼© */
            max-height: calc(var(--vh, 1vh) * 100 - 300px); /* ä½¿ç”¨åŠ¨æ€è§†å£é«˜åº¦ */
        }

        .conversation-area::-webkit-scrollbar {
            width: 6px;
        }

        .conversation-area::-webkit-scrollbar-track {
            background: var(--surface-soft);
            border-radius: 3px;
        }

        .conversation-area::-webkit-scrollbar-thumb {
            background: rgba(26, 95, 158, 0.3);
            border-radius: 3px;
        }

        .conversation-area::-webkit-scrollbar-thumb:hover {
            background: rgba(26, 95, 158, 0.5);
        }

        /* ç§»åŠ¨ç«¯æ»šåŠ¨æ¡éšè— */
        @media (max-width: 768px) {
            .conversation-area::-webkit-scrollbar {
                width: 0px;
                background: transparent;
            }
            
            .chat-container {
                height: calc(var(--vh, 1vh) * 100);
            max-height: calc(var(--vh, 1vh) * 100);
            }
            
            /* å¼ºåˆ¶è®¾ç½®å¯¹è¯åŒºåŸŸçš„æœ€å¤§é«˜åº¦ */
            .conversation-area {
                height: auto;
                max-height: calc(var(--vh, 1vh) * 100 - 150px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: var(--shadow-soft);
            animation: slideInUp 0.3s ease;
        }
        
        /* æ¶ˆæ¯å†…å®¹å®¹å™¨ */
        .message-content {
            width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .message.user {
            background: linear-gradient(135deg, var(--primary-deep), var(--primary-light));
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 6px;
        }

        .message.ai {
            background: var(--surface-soft);
            border: 1px solid rgba(26, 95, 158, 0.08);
            color: var(--text-primary);
            margin-right: auto;
            border-bottom-left-radius: 6px;
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 4px;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--surface-soft);
            border-radius: 18px;
            border-bottom-left-radius: 6px;
            max-width: 80px;
            margin-right: auto;
            box-shadow: var(--shadow-soft);
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* ===== è¾“å…¥åŒºåŸŸæ ·å¼ ===== */
        .input-area {
            padding: 20px;
            border-top: 1px solid rgba(26, 95, 158, 0.08);
            background: var(--surface);
        }

        .input-tabs {
            display: flex;
            margin-bottom: 15px;
            background: var(--surface-soft);
            border-radius: 12px;
            padding: 4px;
        }

        .input-tab {
            flex: 1;
            padding: 8px 16px;
            border: none;
            background: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--text-muted);
        }

        .input-tab.active {
            background: var(--surface);
            color: var(--primary-deep);
            box-shadow: var(--shadow-soft);
        }

        .input-content {
            display: none;
        }

        .input-content.active {
            display: block;
        }

        .text-input-area {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .text-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid rgba(26, 95, 158, 0.2);
            border-radius: 20px;
            background: var(--surface);
            color: var(--text-primary);
            resize: none;
            min-height: 44px;
            max-height: 120px;
            transition: all 0.3s ease;
            font-family: inherit;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(26, 95, 158, 0.1);
            -webkit-tap-highlight-color: transparent;
        }

        /* ç§»åŠ¨ç«¯è¾“å…¥æ¡†ä¼˜åŒ– */
        @media (max-width: 768px) {
            .text-input {
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
                -webkit-user-select: text;
                user-select: text;
                -webkit-touch-callout: default;
            }
        }

        .send-button {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-deep), var(--primary-dark));
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-soft);
        }

        .send-button:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--primary-light), var(--primary-deep));
            transform: scale(1.05);
            box-shadow: var(--shadow-hover);
        }

        .send-button:active:not(:disabled) {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-deep));
            transform: scale(0.95);
        }

        .send-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .voice-input-area {
            text-align: center;
        }

        .record-button {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--error), #c0392b);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            margin: 0 auto 15px;
            box-shadow: var(--shadow-card);
            text-align: center;
            line-height: 1.1;
            padding: 2px;
        }

        .record-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: scale(1.05);
        }

        .record-button:active:not(:disabled) {
            background: linear-gradient(135deg, #a93226, #922b21);
            transform: scale(0.95);
        }

        .record-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .record-button.recording {
            animation: recordPulse 1.5s infinite;
        }

        @keyframes recordPulse {
            0% {
                background: linear-gradient(135deg, var(--error), #c0392b);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            50% {
                background: linear-gradient(135deg, #ff6b6b, var(--error));
                box-shadow: 0 0 0 20px rgba(231, 76, 60, 0);
            }
            100% {
                background: linear-gradient(135deg, var(--error), #c0392b);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }

        .audio-visualizer {
            height: 60px;
            width: 100%;
            border: 1px solid rgba(26, 95, 158, 0.2);
            border-radius: 12px;
            background: var(--surface-soft);
            display: none;
        }

        /* ===== è®¾ç½®é¢æ¿æ ·å¼ ===== */
        .settings-panel {
                position: fixed;
                top: 0;
                right: -400px;
                width: 380px;
                height: calc(100vh - 60px);
                background: var(--surface);
                border-left: 1px solid rgba(26, 95, 158, 0.08);
                box-shadow: var(--shadow-card);
                transition: right 0.3s ease;
                z-index: 99;
                overflow-y: auto;
            }

        .settings-panel.open {
            right: 0;
        }

        .settings-header {
            padding: 20px;
            border-bottom: 1px solid rgba(26, 95, 158, 0.08);
            background: var(--surface-soft);
        }

        .settings-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-deep);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-content {
            padding: 20px;
        }

        .setting-group {
            margin-bottom: 25px;
        }

        .setting-group h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .setting-item label {
            width: 100px;
            text-align: right;
            margin-right: 15px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .setting-item input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid rgba(26, 95, 158, 0.2);
            border-radius: 8px;
            background: var(--surface);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .setting-item input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(26, 95, 158, 0.1);
        }

        .connect-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary-deep), var(--primary-dark));
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            margin-top: 15px;
        }

        .connect-button:hover {
            background: linear-gradient(135deg, var(--primary-light), var(--primary-deep));
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        /* ===== åº•éƒ¨å¯¼èˆªæ æ ·å¼ ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100vw;
            height: 70px;
            background: #ffffff;
            border-top: 1px solid rgba(26, 95, 158, 0.08);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            box-shadow: 0 -4px 16px rgba(26, 95, 158, 0.12);
            backdrop-filter: blur(10px);
            /* æ”¯æŒåˆ˜æµ·å±ç­‰å¼‚å½¢å± */
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            animation: slideInUp 0.6s ease forwards;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 12px;
            min-width: 60px;
        }

        .nav-item:hover {
            background: var(--surface-hover);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(26, 95, 158, 0.1), rgba(26, 95, 158, 0.05));
            border: 1px solid rgba(26, 95, 158, 0.2);
            transition: all 0.3s ease;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-bottom: 4px;
            transition: all 0.3s ease;
        }

        .nav-item.active .nav-icon {
            color: var(--primary-deep);
            transform: scale(1.1);
            transition: all 0.3s ease;
        }

        .nav-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-item.active .nav-label {
            color: var(--primary-deep);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        /* ä¸ºé¡µé¢å†…å®¹æ·»åŠ åº•éƒ¨é—´è· */
        .main-content {
            padding-top: calc(70px + env(safe-area-inset-top));
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            min-height: 100vh;
            min-height: 100dvh;
        }

        /* ===== åŠ¨ç”»æ•ˆæœ ===== */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .fade-in {
            animation: fadeIn 0.6s ease forwards;
        }

        .slide-in-up {
            animation: slideInUp 0.6s ease forwards;
        }

        /* ===== å“åº”å¼è®¾è®¡ ===== */
        @media (max-width: 768px) {

            

            
            /* ä¸»å®¹å™¨ä¼˜åŒ– */
            .container {
                width: 100%;
                height: 100vh;
                padding-top: 60px;
                background: transparent;
                position: relative;
                overflow-y: auto;
                overflow-x: hidden;
            }
            
            /* å¯¹è¯å®¹å™¨ä¼˜åŒ– */
            .chat-container {
                margin: 10px;
                margin-bottom: 15px;
                border-radius: 15px;
            }
            
            .chat-header {
                padding: 15px;
            }
            
            .chat-title {
                font-size: 1.1rem;
            }
            
            .chat-status {
                font-size: 0.8rem;
                gap: 15px;
            }
            
            /* å¯¹è¯åŒºåŸŸä¼˜åŒ– */
            .conversation-area {
                padding: 15px;
                gap: 12px;
                max-height: calc(var(--vh, 1vh) * 100 - 280px); /* ç§»åŠ¨ç«¯ä½¿ç”¨åŠ¨æ€è§†å£é«˜åº¦ */
            }
            
            .message {
                max-width: 85%;
                padding: 10px 14px;
                font-size: 0.9rem;
                border-radius: 16px;
            }
            
            .message.user {
                border-bottom-right-radius: 4px;
            }
            
            .message.ai {
                border-bottom-left-radius: 4px;
            }
            
            .message-time {
                font-size: 0.7rem;
            }
            
            /* è¾“å…¥åŒºåŸŸä¼˜åŒ– */
            .input-area {
                padding: 15px;
                padding-bottom: 20px;
            }
            
            .input-tabs {
                margin-bottom: 12px;
                padding: 3px;
            }
            
            .input-tab {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
            
            .text-input-area {
                gap: 10px;
            }
            
            .text-input {
                padding: 10px 14px;
                font-size: 0.9rem;
                min-height: 40px;
                max-height: 100px;
            }
            
            .send-button {
                width: 40px;
                height: 40px;
                font-size: 0.9rem;
            }
            
            .record-button {
                width: 50px;
                height: 50px;
                font-size: 0.7rem;
                margin-bottom: 12px;
            }
            
            /* è®¾ç½®é¢æ¿ä¼˜åŒ– */
            .settings-panel {
                width: 100%;
                right: -100%;
                top: 50px;
                height: calc(100vh - 110px);
            }
            
            .settings-header {
                padding: 15px;
            }
            
            .settings-title {
                font-size: 1rem;
            }
            
            .settings-content {
                padding: 15px;
            }
            
            .setting-group {
                margin-bottom: 20px;
            }
            
            .setting-group h3 {
                font-size: 0.95rem;
                margin-bottom: 12px;
            }
            
            .setting-item {
                flex-direction: column;
                align-items: stretch;
                margin-bottom: 10px;
            }
            
            .setting-item label {
                width: auto;
                text-align: left;
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 0.85rem;
            }
            
            .setting-item input {
                font-size: 0.9rem;
                padding: 10px 12px;
            }
            
            .connect-button {
                padding: 10px;
                font-size: 0.9rem;
                margin-top: 12px;
            }
            
            /* æ¬¢è¿æ¶ˆæ¯ä¼˜åŒ– */
            .welcome-message {
                padding: 30px 15px;
            }
            
            .welcome-message i {
                font-size: 2.5rem;
                margin-bottom: 12px;
            }
            
            .welcome-message h3 {
                font-size: 1.1rem;
                margin-bottom: 6px;
            }
            
            .welcome-message p {
                font-size: 0.9rem;
            }
            
            /* çŠ¶æ€æŒ‡ç¤ºå™¨ä¼˜åŒ– */
            #scriptStatus {
                padding: 15px 20px;
                font-size: 0.9rem;
                border-radius: 12px;
                max-width: 90%;
                text-align: center;
            }
            
            /* éŸ³é¢‘å¯è§†åŒ–å™¨ä¼˜åŒ– */
            .audio-visualizer {
                height: 50px;
                border-radius: 10px;
            }
            
            /* æ‰“å­—æŒ‡ç¤ºå™¨ä¼˜åŒ– */
            .typing-indicator {
                padding: 10px 14px;
                max-width: 70px;
            }
            
            .typing-dot {
                width: 5px;
                height: 5px;
            }
        }
        
        /* å°å±å¹•è®¾å¤‡è¿›ä¸€æ­¥ä¼˜åŒ– */
        @media (max-width: 480px) {
            .top-header {
                height: 45px;
                padding: 0 12px;
            }
            
            .header-logo {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
            }
            
            .header-title {
                font-size: 0.8rem;
            }
            
            .header-icon {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
            }
            
            .container {
                padding-top: calc(45px + env(safe-area-inset-top));
            }
            
            .chat-container {
                margin: 8px;
            }
            
            .message {
                max-width: 90%;
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .text-input {
                font-size: 0.85rem;
                padding: 8px 12px;
            }
            
            .send-button {
                width: 36px;
                height: 36px;
            }
            
            .record-button {
                width: 45px;
                height: 45px;
                font-size: 0.65rem;
            }
        }
        
        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (max-width: 768px) and (orientation: landscape) {
            .top-header {
                height: 45px;
            }
            
            .container {
                padding-top: calc(45px + env(safe-area-inset-top));
            }
            
            .chat-header {
                padding: 12px 15px;
            }
            
            .conversation-area {
                padding: 12px 15px;
                max-height: calc(var(--vh, 1vh) * 100 - 250px); /* æ¨ªå±æ¨¡å¼ä½¿ç”¨åŠ¨æ€è§†å£é«˜åº¦ */
            }
            
            .input-area {
                padding: 12px 15px;
            }
            
            .nav-item {
                padding: 4px 6px;
            }
            
            .nav-icon {
                margin-bottom: 1px;
            }
        }

        /* ===== åŠ è½½çŠ¶æ€ ===== */
        #scriptStatus {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 30px;
            border-radius: 16px;
            font-weight: 600;
            box-shadow: var(--shadow-card);
            z-index: 1000;
            background: var(--surface);
            color: var(--primary-deep);
            border: 2px solid var(--primary-light);
        }

        .welcome-message {
            text-align: left;
            padding: 5px 15px;
            color: var(--text-muted);
        }

        .welcome-message i {
            font-size: 3rem;
            color: var(--primary-light);
            margin-bottom: 15px;
        }

        .welcome-message h3 {
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        /* ===== å¿«æ·æŒ‰é’®æ ·å¼ ===== */
        .quick-button {
            padding: 6px 12px;
            border: 1px solid var(--primary-light);
            border-radius: 16px;
            background: var(--surface);
            color: var(--primary-deep);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            font-weight: 500;
            box-shadow: none;
            white-space: nowrap;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .quick-button:hover {
            background: linear-gradient(135deg, var(--primary-light), var(--primary-deep));
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        .quick-button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        
        /* æ¶ˆæ¯å†…çš„å¿«æ·æŒ‰é’®å®¹å™¨ */
        .message .quick-buttons {
            margin-top: 12px !important;
            padding: 8px 0 0 0;
            border-top: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        /* ===== Markdownæ ·å¼æ”¯æŒ ===== */
        .message h1, .message h2, .message h3, .message h4, .message h5, .message h6 {
            margin: 8px 0;
            color: inherit;
            font-weight: 600;
            line-height: 1.4;
        }
        
        .message h1 { font-size: 1.4em; }
        .message h2 { font-size: 1.3em; }
        .message h3 { font-size: 1.2em; }
        .message h4 { font-size: 1.1em; }
        .message h5 { font-size: 1.05em; }
        .message h6 { font-size: 1em; }
        
        .message p {
            margin: 6px 0;
            line-height: 1.5;
        }
        
        .message ul, .message ol {
            margin: 6px 0;
            padding-left: 20px;
        }
        
        .message li {
            margin: 3px 0;
            line-height: 1.4;
        }
        
        .message blockquote {
            margin: 8px 0;
            padding: 8px 12px;
            border-left: 3px solid var(--primary-light);
            background: rgba(26, 95, 158, 0.05);
            border-radius: 0 8px 8px 0;
            font-style: italic;
        }
        
        .message code {
            background: rgba(26, 95, 158, 0.1);
            padding: 2px 4px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--primary-deep);
        }
        
        .message pre {
            background: rgba(26, 95, 158, 0.05);
            border: 1px solid rgba(26, 95, 158, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.4;
        }
        
        .message pre code {
            background: none;
            padding: 0;
            color: inherit;
        }
        
        .message table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 0.9em;
        }
        
        .message th, .message td {
            border: 1px solid rgba(26, 95, 158, 0.2);
            padding: 6px 8px;
            text-align: left;
        }
        
        .message th {
            background: rgba(26, 95, 158, 0.1);
            font-weight: 600;
        }
        
        .message tr:nth-child(even) {
            background: rgba(26, 95, 158, 0.02);
        }
        
        .message a {
            color: var(--primary-light);
            text-decoration: none;
            border-bottom: 1px dotted transparent;
            transition: all 0.3s ease;
        }
        
        .message a:hover {
            border-bottom-color: var(--primary-light);
            text-decoration: underline;
        }
        
        .message strong {
            font-weight: 600;
            color: inherit;
        }
        
        .message em {
            font-style: italic;
            color: inherit;
        }
        
        .message hr {
            border: none;
            height: 1px;
            background: rgba(26, 95, 158, 0.2);
            margin: 12px 0;
        }
        
        .message img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 8px 0;
        }
        
        /* ç”¨æˆ·æ¶ˆæ¯ä¸­çš„Markdownæ ·å¼è°ƒæ•´ */
        .message.user h1, .message.user h2, .message.user h3, 
        .message.user h4, .message.user h5, .message.user h6 {
            color: rgba(255, 255, 255, 0.95);
        }
        
        .message.user blockquote {
            border-left-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .message.user code {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.95);
        }
        
        .message.user pre {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .message.user pre code {
            color: rgba(255, 255, 255, 0.95);
        }
        
        .message.user th, .message.user td {
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .message.user th {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .message.user tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .message.user a {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .message.user a:hover {
            border-bottom-color: rgba(255, 255, 255, 0.9);
        }
        
        .message.user hr {
            background: rgba(255, 255, 255, 0.3);
        }


    </style>
</head>
<body>

    <!-- é¡¶éƒ¨æ  -->
    <div class="top-header">
        <div class="header-right">
            <div class="header-icon" id="settingsBtn">
                <i class="fas fa-cog"></i>
            </div>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- AIå¯¹è¯åŒºåŸŸ -->
        <div class="chat-container">
            <!-- å¯¹è¯å¤´éƒ¨ (å·²éšè—) -->
            <div class="chat-header" style="display: none;">
                <div class="chat-title">
                    å¼€å‘æ¨¡å¼
                </div>
                <div class="chat-status">
                    <div class="status-indicator">
                        <span>WebSocket: <span id="connectionStatus">æœªè¿æ¥</span></span>
                    </div>
                    <div class="status-indicator">
                        <span>OTA: <span id="otaStatus">æœªè¿æ¥</span></span>
                    </div>
                </div>
            </div>

            <!-- å¯¹è¯åŒºåŸŸ -->
            <div class="conversation-area" id="conversationArea">
                <div class="message ai welcome-message">
                    <div class="message-content">**æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ AIè¥å…»é¡¾é—®**

è¯·é—®æˆ‘æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°æ‚¨çš„å—ï¼Ÿ

æˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›ä»¥ä¸‹æœåŠ¡ï¼š

ğŸ¥— **è¥å…»å’¨è¯¢** - ä¸ªæ€§åŒ–é¥®é£Ÿå»ºè®®     

ğŸ“Š **å¥åº·åˆ†æ** - åŸºäºæ•°æ®çš„å¥åº·è¯„ä¼°         

ğŸ’ª **å¥èº«æŒ‡å¯¼** - ç§‘å­¦è¿åŠ¨æ–¹æ¡ˆ

ğŸ½ï¸ **é£Ÿè°±æ¨è** - å¥åº·ç¾å‘³èœè°±</div>
                    <div class="message-time">åˆšåˆš</div>
                    
                    <!-- å¿«æ·æŒ‰é’®åŒºåŸŸ -->
                    <div class="quick-buttons" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-start;">
                        <button class="quick-button" onclick="sendQuickMessage('æˆ‘æƒ³å¥åº·å¢è„‚')">æˆ‘æƒ³å¥åº·å¢è„‚</button>
                        <button class="quick-button" onclick="sendQuickMessage('æˆ‘æƒ³å¥åº·å‡è‚¥')">æˆ‘æƒ³å¥åº·å‡è‚¥</button>
                        <button class="quick-button" onclick="sendQuickMessage('æˆ‘æƒ³å‡è¡¡é¥®é£Ÿ')">æˆ‘æƒ³å‡è¡¡é¥®é£Ÿ</button>
                        <button class="quick-button" onclick="sendQuickMessage('æˆ‘åº”è¯¥æ€ä¹ˆåƒ')">æˆ‘åº”è¯¥æ€ä¹ˆåƒ</button>
                        <button class="quick-button" onclick="sendQuickMessage('ä»æ•°æ®åº“ä¸­æŸ¥è¯¢æˆ‘çš„é¥®é£Ÿä¹ æƒ¯')">ä»æ•°æ®åº“ä¸­æŸ¥è¯¢æˆ‘çš„é¥®é£Ÿä¹ æƒ¯</button>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-area">
                <div class="input-tabs">
                    <button class="input-tab active" data-tab="text">
                        <i class="fas fa-keyboard"></i> æ–‡æœ¬è¾“å…¥
                    </button>
                    <button class="input-tab" data-tab="voice">
                        <i class="fas fa-microphone"></i> è¯­éŸ³è¾“å…¥
                    </button>
                </div>

                <div class="input-content active" id="textInputContent">
                    <div class="text-input-area">
                        <textarea class="text-input" id="messageInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." disabled rows="1"></textarea>
                        <button class="send-button" id="sendTextButton" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

                <div class="input-content" id="voiceInputContent">
                    <div class="voice-input-area">
                        <button class="record-button" id="recordButton" disabled>
                            <i class="fas fa-microphone"></i>
                        </button>
                        <canvas class="audio-visualizer" id="audioVisualizer"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®é¢æ¿ -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <div class="settings-title">
                <i class="fas fa-cog"></i>
                è¿æ¥è®¾ç½®
            </div>
        </div>
        <div class="settings-content">
            <div class="setting-group">
                <h3><i class="fas fa-server"></i> æœåŠ¡å™¨é…ç½®</h3>
                <div class="setting-item">
                    <label>WebSocket:</label>
                    <input type="text" id="serverUrl" value="ws://192.168.101.251:8000/xiaozhi/v1/" placeholder="WebSocketæœåŠ¡å™¨åœ°å€">
                </div>
                <div class="setting-item">
                    <label>OTAæœåŠ¡:</label>
                    <input type="text" id="otaUrl" value="http://192.168.101.251:8002/xiaozhi/ota/" placeholder="OTAæœåŠ¡å™¨åœ°å€">
                </div>
                <button class="connect-button" id="connectButton">è¿æ¥æœåŠ¡å™¨</button>
            </div>

            <div class="setting-group">
                <h3><i class="fas fa-mobile-alt"></i> è®¾å¤‡ä¿¡æ¯</h3>
                <div class="setting-item">
                    <label>è®¾å¤‡MAC:</label>
                    <input type="text" id="deviceMac" placeholder="è®¾å¤‡MACåœ°å€">
                </div>
                <div class="setting-item">
                    <label>è®¾å¤‡åç§°:</label>
                    <input type="text" id="deviceName" value="Webæµ‹è¯•è®¾å¤‡" placeholder="è®¾å¤‡åç§°">
                </div>
                <div class="setting-item">
                    <label>å®¢æˆ·ç«¯ID:</label>
                    <input type="text" id="clientId" value="web_test_client" placeholder="å®¢æˆ·ç«¯ID">
                </div>
                <div class="setting-item">
                    <label>è®¤è¯Token:</label>
                    <input type="text" id="token" value="your-token1" placeholder="è®¤è¯Token">
                </div>
                <button class="connect-button" id="authTestButton">æµ‹è¯•è®¤è¯</button>
            </div>
        </div>
    </div>



    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="scriptStatus">
        æ­£åœ¨åˆå§‹åŒ–AIåŠ©æ‰‹...
    </div>

    
    <!-- Opusè§£ç åº“ -->
    <script src="../static/js/libopus.js"></script>
    
    <script>
        // éœ€è¦åŠ è½½çš„è„šæœ¬åˆ—è¡¨ - ç§»é™¤Opusä¾èµ–
        const scriptFiles = [];

        // è„šæœ¬åŠ è½½çŠ¶æ€
        const scriptStatus = {
            loading: 0,
            loaded: 0,
            failed: 0,
            total: scriptFiles.length
        };

        // æ£€æŸ¥Opusåº“æ˜¯å¦å·²åŠ è½½
        function checkOpusLoaded() {
            try {
                // æ£€æŸ¥Moduleæ˜¯å¦å­˜åœ¨ï¼ˆæœ¬åœ°åº“å¯¼å‡ºçš„å…¨å±€å˜é‡ï¼‰
                if (typeof Module === 'undefined') {
                    throw new Error('Opusåº“æœªåŠ è½½ï¼ŒModuleå¯¹è±¡ä¸å­˜åœ¨');
                }

                // å°è¯•å…ˆä½¿ç”¨Module.instanceï¼ˆlibopus.jsæœ€åä¸€è¡Œå¯¼å‡ºæ–¹å¼ï¼‰
                if (typeof Module.instance !== 'undefined' && typeof Module.instance._opus_decoder_get_size === 'function') {
                    // ä½¿ç”¨Module.instanceå¯¹è±¡æ›¿æ¢å…¨å±€Moduleå¯¹è±¡
                    window.ModuleInstance = Module.instance;
                    log('Opusåº“åŠ è½½æˆåŠŸï¼ˆä½¿ç”¨Module.instanceï¼‰', 'success');
                    updateScriptStatus('Opusåº“åŠ è½½æˆåŠŸ', 'success');

                    // 3ç§’åéšè—çŠ¶æ€
                    const statusElement = document.getElementById('scriptStatus');
                    if (statusElement) statusElement.style.display = 'none';
                    return;
                }

                // å¦‚æœæ²¡æœ‰Module.instanceï¼Œæ£€æŸ¥å…¨å±€Moduleå‡½æ•°
                if (typeof Module._opus_decoder_get_size === 'function') {
                    window.ModuleInstance = Module;
                    log('Opusåº“åŠ è½½æˆåŠŸï¼ˆä½¿ç”¨å…¨å±€Moduleï¼‰', 'success');
                    updateScriptStatus('Opusåº“åŠ è½½æˆåŠŸ', 'success');

                    // 3ç§’åéšè—çŠ¶æ€
                    const statusElement = document.getElementById('scriptStatus');
                    if (statusElement) statusElement.style.display = 'none';
                    return;
                }

                throw new Error('Opusè§£ç å‡½æ•°æœªæ‰¾åˆ°ï¼Œå¯èƒ½Moduleç»“æ„ä¸æ­£ç¡®');
            } catch (err) {
                log(`Opusåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥libopus.jsæ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æ­£ç¡®: ${err.message}`, 'error');
                updateScriptStatus('Opusåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥libopus.jsæ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æ­£ç¡®', 'error');
            }
        }

        // æ›´æ–°è„šæœ¬çŠ¶æ€æ˜¾ç¤º
        function updateScriptStatus(message, type) {
            const statusElement = document.getElementById('scriptStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `script-status ${type}`;
                statusElement.style.display = 'block';
                statusElement.style.width = 'auto';
            }
        }

        // å…¨å±€å˜é‡
        let websocket = null;
        let mediaRecorder = null;
        let audioContext = null;
        let analyser = null;
        let audioChunks = [];
        let isRecording = false;
        let visualizerCanvas = document.getElementById('audioVisualizer');
        let visualizerContext = visualizerCanvas.getContext('2d');
        let audioQueue = [];
        let isPlaying = false;
        let opusDecoder = null; // Opusè§£ç å™¨
        let visualizationRequest = null; // åŠ¨ç”»å¸§è¯·æ±‚ID

        // éŸ³é¢‘æµç¼“å†²ç›¸å…³
        let audioBuffers = []; // ç”¨äºå­˜å‚¨æ¥æ”¶åˆ°çš„æ‰€æœ‰éŸ³é¢‘æ•°æ®
        let totalAudioSize = 0; // è·Ÿè¸ªç´¯ç§¯çš„éŸ³é¢‘å¤§å°

        let audioBufferQueue = [];     // å­˜å‚¨æ¥æ”¶åˆ°çš„éŸ³é¢‘åŒ…
        let isAudioBuffering = false;  // æ˜¯å¦æ­£åœ¨ç¼“å†²éŸ³é¢‘
        let isAudioPlaying = false;    // æ˜¯å¦æ­£åœ¨æ’­æ”¾éŸ³é¢‘
        const BUFFER_THRESHOLD = 3;    // ç¼“å†²åŒ…æ•°é‡é˜ˆå€¼ï¼Œè‡³å°‘ç´¯ç§¯3ä¸ªåŒ…å†å¼€å§‹æ’­æ”¾
        const MIN_AUDIO_DURATION = 0.1; // æœ€å°éŸ³é¢‘é•¿åº¦(ç§’)ï¼Œå°äºè¿™ä¸ªé•¿åº¦çš„éŸ³é¢‘ä¼šè¢«åˆå¹¶
        let streamingContext = null;   // éŸ³é¢‘æµä¸Šä¸‹æ–‡
        const SAMPLE_RATE = 16000;     // é‡‡æ ·ç‡
        const CHANNELS = 1;            // å£°é“æ•°
        const FRAME_SIZE = 960;        // å¸§å¤§å°

        // DOMå…ƒç´ 
        const connectButton = document.getElementById('connectButton');
        const serverUrlInput = document.getElementById('serverUrl');
        const connectionStatus = document.getElementById('connectionStatus');
        const otaStatus = document.getElementById('otaStatus');
        const messageInput = document.getElementById('messageInput');
        const sendTextButton = document.getElementById('sendTextButton');
        const recordButton = document.getElementById('recordButton');
        const stopButton = document.getElementById('stopButton');
        const conversationDiv = document.getElementById('conversationArea');
        const logContainer = document.createElement('div'); // åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçš„æ—¥å¿—å®¹å™¨

        // æå–Opuså¸§æ•°æ®çš„å‡½æ•°
        function extractOpusFrames(webmData) {
            // ç®€å•çš„WebMè§£æï¼Œæå–Opusæ•°æ®
            // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…çš„WebMè§£æä¼šæ›´å¤æ‚
            try {
                // æŸ¥æ‰¾Opusæ•°æ®çš„èµ·å§‹ä½ç½®
                // WebMæ–‡ä»¶æ ¼å¼ä¸­ï¼ŒOpusæ•°æ®é€šå¸¸åœ¨ç‰¹å®šçš„ä½ç½®
                let opusStart = -1;
                
                // æŸ¥æ‰¾Opusç¼–è§£ç å™¨æ ‡è¯†
                for (let i = 0; i < webmData.length - 4; i++) {
                    // æŸ¥æ‰¾å¯èƒ½çš„Opusæ•°æ®å—
                    if (webmData[i] === 0x4F && webmData[i + 1] === 0x70 && 
                        webmData[i + 2] === 0x75 && webmData[i + 3] === 0x73) {
                        opusStart = i;
                        break;
                    }
                }
                
                if (opusStart === -1) {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°Opusæ ‡è¯†ï¼Œå°è¯•è·³è¿‡WebMå¤´éƒ¨
                    // é€šå¸¸WebMå¤´éƒ¨åœ¨å‰å‡ ç™¾å­—èŠ‚
                    const headerSize = Math.min(1000, webmData.length);
                    return webmData.slice(headerSize);
                }
                
                // ä»æ‰¾åˆ°çš„ä½ç½®å¼€å§‹æå–æ•°æ®
                return webmData.slice(opusStart);
            } catch (error) {
                log(`æå–Opuså¸§å¤±è´¥: ${error.message}`, 'error');
                // å¦‚æœæå–å¤±è´¥ï¼Œè¿”å›åŸå§‹æ•°æ®
                return webmData;
            }
        }

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            // ä½¿ç”¨æ§åˆ¶å°è¾“å‡ºæ—¥å¿—ï¼Œå› ä¸ºUIä¸­æ²¡æœ‰ä¸“é—¨çš„æ—¥å¿—å®¹å™¨
            const timestamp = `[${new Date().toLocaleTimeString()}.${new Date().getMilliseconds().toString().padStart(3, '0')}]`;
            const logMessage = `${timestamp} ${message}`;
            
            // æ ¹æ®ç±»å‹è¾“å‡ºåˆ°ä¸åŒçš„æ§åˆ¶å°æ–¹æ³•
            switch (type) {
                case 'error':
                    console.error(logMessage);
                    break;
                case 'warning':
                    console.warn(logMessage);
                    break;
                case 'success':
                    console.log(`%c${logMessage}`, 'color: green');
                    break;
                case 'debug':
                    console.debug(logMessage);
                    break;
                default:
                    console.log(logMessage);
            }
        }

        // åˆå§‹åŒ–å¯è§†åŒ–å™¨
        function initVisualizer() {
            visualizerCanvas.width = visualizerCanvas.clientWidth;
            visualizerCanvas.height = visualizerCanvas.clientHeight;
            visualizerContext.fillStyle = '#fafafa';
            visualizerContext.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
        }

        // ç»˜åˆ¶éŸ³é¢‘å¯è§†åŒ–æ•ˆæœ
        function drawVisualizer(dataArray) {
            visualizationRequest = requestAnimationFrame(() => drawVisualizer(dataArray));

            if (!isRecording) return;

            analyser.getByteFrequencyData(dataArray);

            visualizerContext.fillStyle = '#fafafa';
            visualizerContext.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);

            const barWidth = (visualizerCanvas.width / dataArray.length) * 2.5;
            let barHeight;
            let x = 0;

            for (let i = 0; i < dataArray.length; i++) {
                barHeight = dataArray[i] / 2;

                visualizerContext.fillStyle = `rgb(${barHeight + 100}, 50, 50)`;
                visualizerContext.fillRect(x, visualizerCanvas.height - barHeight, barWidth, barHeight);

                x += barWidth + 1;
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°ä¼šè¯è®°å½•
        function addMessage(text, isUser = false) {
            // ä¸ç§»é™¤æ¬¢è¿æ¶ˆæ¯ï¼Œä¿æŒæ¬¢è¿è¯­æ˜¾ç¤ºçŠ¶æ€
            // const welcomeMessage = conversationDiv.querySelector('.welcome-message');
            // if (welcomeMessage) {
            //     welcomeMessage.remove();
            // }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            
            // åˆ›å»ºæ¶ˆæ¯å†…å®¹å®¹å™¨
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // ä½¿ç”¨marked.jsè§£æMarkdownå†…å®¹
            try {
                messageContent.innerHTML = marked.parse(text);
            } catch (error) {
                console.error('Markdownè§£æé”™è¯¯:', error);
                // å¦‚æœè§£æå¤±è´¥ï¼Œå›é€€åˆ°çº¯æ–‡æœ¬æ˜¾ç¤º
                messageContent.textContent = text;
            }
            
            messageDiv.appendChild(messageContent);
            
            // æ·»åŠ æ—¶é—´æˆ³
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = new Date().toLocaleTimeString();
            messageDiv.appendChild(timeDiv);
            
            conversationDiv.appendChild(messageDiv);
            conversationDiv.scrollTop = conversationDiv.scrollHeight;
        }


        // æ£€æŸ¥å½“å‰è¾“å…¥æ¨¡å¼
        function getCurrentInputMode() {
            const activeTab = document.querySelector('.input-tab.active');
            return activeTab ? activeTab.getAttribute('data-tab') : 'voice';
        }

        // å¼€å§‹éŸ³é¢‘ç¼“å†²è¿‡ç¨‹
        function startAudioBuffering() {
            if (isAudioBuffering || isAudioPlaying) return;
            
            // æ£€æŸ¥è¾“å…¥æ¨¡å¼ï¼šæ–‡æœ¬è¾“å…¥æ¨¡å¼ä¸‹ä¸è‡ªåŠ¨æ’­æ”¾éŸ³é¢‘
            const currentMode = getCurrentInputMode();
            if (currentMode === 'text') {
                log('æ–‡æœ¬è¾“å…¥æ¨¡å¼ï¼Œä¸è‡ªåŠ¨æ’­æ”¾éŸ³é¢‘', 'info');
                return;
            }

            isAudioBuffering = true;
            log("å¼€å§‹éŸ³é¢‘ç¼“å†²...", 'info');

            // å…ˆå°è¯•åˆå§‹åŒ–è§£ç å™¨ï¼Œä»¥ä¾¿åœ¨æ’­æ”¾æ—¶å·²å‡†å¤‡å¥½
            initOpusDecoder().catch(error => {
                log(`é¢„åˆå§‹åŒ–Opusè§£ç å™¨å¤±è´¥: ${error.message}`, 'warning');
                // ç»§ç»­ç¼“å†²ï¼Œæˆ‘ä»¬ä¼šåœ¨æ’­æ”¾æ—¶å†æ¬¡å°è¯•åˆå§‹åŒ–
            });

            // è®¾ç½®è¶…æ—¶ï¼Œå¦‚æœåœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ”¶é›†åˆ°è¶³å¤Ÿçš„éŸ³é¢‘åŒ…ï¼Œå°±å¼€å§‹æ’­æ”¾
            setTimeout(() => {
                if (isAudioBuffering && audioBufferQueue.length > 0) {
                    log(`ç¼“å†²è¶…æ—¶ï¼Œå½“å‰ç¼“å†²åŒ…æ•°: ${audioBufferQueue.length}ï¼Œå¼€å§‹æ’­æ”¾`, 'info');
                    playBufferedAudio();
                }
            }, 300); // 300msè¶…æ—¶

            // ç›‘æ§ç¼“å†²è¿›åº¦
            const bufferCheckInterval = setInterval(() => {
                if (!isAudioBuffering) {
                    clearInterval(bufferCheckInterval);
                    return;
                }

                // å½“ç´¯ç§¯äº†è¶³å¤Ÿçš„éŸ³é¢‘åŒ…ï¼Œå¼€å§‹æ’­æ”¾
                if (audioBufferQueue.length >= BUFFER_THRESHOLD) {
                    clearInterval(bufferCheckInterval);
                    log(`å·²ç¼“å†² ${audioBufferQueue.length} ä¸ªéŸ³é¢‘åŒ…ï¼Œå¼€å§‹æ’­æ”¾`, 'info');
                    playBufferedAudio();
                }
            }, 50);
        }

        // æ’­æ”¾å·²ç¼“å†²çš„éŸ³é¢‘
        function playBufferedAudio() {
            if (isAudioPlaying || audioBufferQueue.length === 0) return;

            isAudioPlaying = true;
            isAudioBuffering = false;

            // ç¡®ä¿Opusè§£ç å™¨å·²åˆå§‹åŒ–
            const initDecoderAndPlay = async () => {
                try {
                    // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡å­˜åœ¨
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)({
                            sampleRate: SAMPLE_RATE
                        });
                        log('åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡ï¼Œé‡‡æ ·ç‡: ' + SAMPLE_RATE + 'Hz', 'debug');
                    }

                    // ç¡®ä¿è§£ç å™¨å·²åˆå§‹åŒ–
                    if (!opusDecoder) {
                        log('åˆå§‹åŒ–Opusè§£ç å™¨...', 'info');
                        try {
                            opusDecoder = await initOpusDecoder();
                            if (!opusDecoder) {
                                throw new Error('è§£ç å™¨åˆå§‹åŒ–å¤±è´¥');
                            }
                            log('Opusè§£ç å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                        } catch (error) {
                            log('Opusè§£ç å™¨åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                            isAudioPlaying = false;
                            return;
                        }
                    }

                    // åˆ›å»ºæµå¼æ’­æ”¾ä¸Šä¸‹æ–‡
                    if (!streamingContext) {
                        streamingContext = {
                            queue: [],          // å·²è§£ç çš„PCMé˜Ÿåˆ—
                            playing: false,     // æ˜¯å¦æ­£åœ¨æ’­æ”¾
                            endOfStream: false, // æ˜¯å¦æ”¶åˆ°ç»“æŸä¿¡å·
                            source: null,       // å½“å‰éŸ³é¢‘æº
                            totalSamples: 0,    // ç´¯ç§¯çš„æ€»æ ·æœ¬æ•°
                            lastPlayTime: 0,    // ä¸Šæ¬¡æ’­æ”¾çš„æ—¶é—´æˆ³

                            // å°†Opusæ•°æ®è§£ç ä¸ºPCM
                            decodeOpusFrames: async function (opusFrames) {
                                if (!opusDecoder) {
                                    log('Opusè§£ç å™¨æœªåˆå§‹åŒ–ï¼Œæ— æ³•è§£ç ', 'error');
                                    return;
                                }

                                let decodedSamples = [];

                                for (const frame of opusFrames) {
                                    try {
                                        // ä½¿ç”¨Opusè§£ç å™¨è§£ç 
                                        const frameData = opusDecoder.decode(frame);
                                        if (frameData && frameData.length > 0) {
                                            // è½¬æ¢ä¸ºFloat32
                                            const floatData = convertInt16ToFloat32(frameData);
                                            // ä½¿ç”¨å¾ªç¯æ›¿ä»£å±•å¼€è¿ç®—ç¬¦
                                            for (let i = 0; i < floatData.length; i++) {
                                                decodedSamples.push(floatData[i]);
                                            }
                                        }
                                    } catch (error) {
                                        log("Opusè§£ç å¤±è´¥: " + error.message, 'error');
                                    }
                                }

                                if (decodedSamples.length > 0) {
                                    // ä½¿ç”¨å¾ªç¯æ›¿ä»£å±•å¼€è¿ç®—ç¬¦
                                    for (let i = 0; i < decodedSamples.length; i++) {
                                        this.queue.push(decodedSamples[i]);
                                    }
                                    this.totalSamples += decodedSamples.length;

                                    // å¦‚æœç´¯ç§¯äº†è‡³å°‘0.2ç§’çš„éŸ³é¢‘ï¼Œå¼€å§‹æ’­æ”¾
                                    const minSamples = SAMPLE_RATE * MIN_AUDIO_DURATION;
                                    if (!this.playing && this.queue.length >= minSamples) {
                                        this.startPlaying();
                                    }
                                } else {
                                    log('æ²¡æœ‰æˆåŠŸè§£ç çš„æ ·æœ¬', 'warning');
                                }
                            },

                            // å¼€å§‹æ’­æ”¾éŸ³é¢‘
                            startPlaying: function () {
                                if (this.playing || this.queue.length === 0) return;

                                this.playing = true;

                                // åˆ›å»ºæ–°çš„éŸ³é¢‘ç¼“å†²åŒº
                                const minPlaySamples = Math.min(this.queue.length, SAMPLE_RATE); // æœ€å¤šæ’­æ”¾1ç§’
                                const currentSamples = this.queue.splice(0, minPlaySamples);

                                const audioBuffer = audioContext.createBuffer(CHANNELS, currentSamples.length, SAMPLE_RATE);
                                audioBuffer.copyToChannel(new Float32Array(currentSamples), 0);

                                // åˆ›å»ºéŸ³é¢‘æº
                                this.source = audioContext.createBufferSource();
                                this.source.buffer = audioBuffer;

                                // åˆ›å»ºå¢ç›ŠèŠ‚ç‚¹ç”¨äºå¹³æ»‘è¿‡æ¸¡
                                const gainNode = audioContext.createGain();

                                // åº”ç”¨æ·¡å…¥æ·¡å‡ºæ•ˆæœé¿å…çˆ†éŸ³
                                const fadeDuration = 0.02; // 20æ¯«ç§’
                                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                                gainNode.gain.linearRampToValueAtTime(1, audioContext.currentTime + fadeDuration);

                                const duration = audioBuffer.duration;
                                if (duration > fadeDuration * 2) {
                                    gainNode.gain.setValueAtTime(1, audioContext.currentTime + duration - fadeDuration);
                                    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + duration);
                                }

                                // è¿æ¥èŠ‚ç‚¹å¹¶å¼€å§‹æ’­æ”¾
                                this.source.connect(gainNode);
                                gainNode.connect(audioContext.destination);

                                this.lastPlayTime = audioContext.currentTime;
                                log(`å¼€å§‹æ’­æ”¾ ${currentSamples.length} ä¸ªæ ·æœ¬ï¼Œçº¦ ${(currentSamples.length / SAMPLE_RATE).toFixed(2)} ç§’`, 'info');

                                // æ’­æ”¾ç»“æŸåçš„å¤„ç†
                                this.source.onended = () => {
                                    this.source = null;
                                    this.playing = false;

                                    // ä½¿ç”¨setTimeouté¿å…é€’å½’è°ƒç”¨
                                    setTimeout(() => {
                                        // å¦‚æœé˜Ÿåˆ—ä¸­è¿˜æœ‰æ•°æ®ï¼Œç»§ç»­æ’­æ”¾
                                        if (this.queue.length > 0) {
                                            this.startPlaying();
                                        } else if (audioBufferQueue.length > 0) {
                                            // ç¼“å†²åŒºæœ‰æ–°æ•°æ®ï¼Œè¿›è¡Œè§£ç 
                                            const frames = [...audioBufferQueue];
                                            audioBufferQueue = [];
                                            this.decodeOpusFrames(frames);
                                        } else if (this.endOfStream) {
                                            // æµå·²ç»“æŸä¸”æ²¡æœ‰æ›´å¤šæ•°æ®
                                            log("éŸ³é¢‘æ’­æ”¾å®Œæˆ", 'info');
                                            isAudioPlaying = false;
                                            this.endOfStream = false;
                                            streamingContext = null;
                                        } else {
                                            // ç­‰å¾…æ›´å¤šæ•°æ®
                                            setTimeout(() => {
                                                // å¦‚æœä»ç„¶æ²¡æœ‰æ–°æ•°æ®ï¼Œä½†æœ‰æ›´å¤šçš„åŒ…åˆ°è¾¾
                                                if (this.queue.length === 0 && audioBufferQueue.length > 0) {
                                                    const frames = [...audioBufferQueue];
                                                    audioBufferQueue = [];
                                                    this.decodeOpusFrames(frames);
                                                } else if (this.queue.length === 0 && audioBufferQueue.length === 0) {
                                                    // çœŸçš„æ²¡æœ‰æ›´å¤šæ•°æ®äº†
                                                    log("éŸ³é¢‘æ’­æ”¾å®Œæˆ (è¶…æ—¶)", 'info');
                                                    isAudioPlaying = false;
                                                    streamingContext = null;
                                                }
                                            }, 500); // 500msè¶…æ—¶
                                        }
                                    }, 10); // 10mså»¶è¿Ÿï¼Œé¿å…ç«‹å³é€’å½’
                                };

                                this.source.start();
                            }
                        };
                    }

                    // å¼€å§‹å¤„ç†ç¼“å†²çš„æ•°æ®
                    const frames = [...audioBufferQueue];
                    audioBufferQueue = []; // æ¸…ç©ºç¼“å†²é˜Ÿåˆ—

                    // è§£ç å¹¶æ’­æ”¾
                    await streamingContext.decodeOpusFrames(frames);

                } catch (error) {
                    log(`æ’­æ”¾å·²ç¼“å†²çš„éŸ³é¢‘å‡ºé”™: ${error.message}`, 'error');
                    isAudioPlaying = false;
                    streamingContext = null;
                }
            };

            // æ‰§è¡Œåˆå§‹åŒ–å’Œæ’­æ”¾
            initDecoderAndPlay();
        }

        // å°†Int16éŸ³é¢‘æ•°æ®è½¬æ¢ä¸ºFloat32éŸ³é¢‘æ•°æ®
        function convertInt16ToFloat32(int16Data) {
            const float32Data = new Float32Array(int16Data.length);
            for (let i = 0; i < int16Data.length; i++) {
                // å°†[-32768,32767]èŒƒå›´è½¬æ¢ä¸º[-1,1]
                float32Data[i] = int16Data[i] / (int16Data[i] < 0 ? 0x8000 : 0x7FFF);
            }
            return float32Data;
        }

        // åˆå§‹åŒ–Opusè§£ç å™¨ - ç¡®ä¿å®Œå…¨åˆå§‹åŒ–å®Œæˆåæ‰è¿”å›
        async function initOpusDecoder() {
            if (opusDecoder) return opusDecoder; // å·²ç»åˆå§‹åŒ–

            try {
                // æ£€æŸ¥ModuleInstanceæ˜¯å¦å­˜åœ¨
                if (typeof window.ModuleInstance === 'undefined') {
                    if (typeof Module !== 'undefined') {
                        // ä½¿ç”¨å…¨å±€Moduleä½œä¸ºModuleInstance
                        window.ModuleInstance = Module;
                        log('ä½¿ç”¨å…¨å±€Moduleä½œä¸ºModuleInstance', 'info');
                    } else {
                        throw new Error('Opusåº“æœªåŠ è½½ï¼ŒModuleInstanceå’ŒModuleå¯¹è±¡éƒ½ä¸å­˜åœ¨');
                    }
                }

                const mod = window.ModuleInstance;

                // åˆ›å»ºè§£ç å™¨å¯¹è±¡
                opusDecoder = {
                    channels: CHANNELS,
                    rate: SAMPLE_RATE,
                    frameSize: FRAME_SIZE,
                    module: mod,
                    decoderPtr: null, // åˆå§‹ä¸ºnull

                    // åˆå§‹åŒ–è§£ç å™¨
                    init: function () {
                        if (this.decoderPtr) return true; // å·²ç»åˆå§‹åŒ–

                        // è·å–è§£ç å™¨å¤§å°
                        const decoderSize = mod._opus_decoder_get_size(this.channels);
                        log(`Opusè§£ç å™¨å¤§å°: ${decoderSize}å­—èŠ‚`, 'debug');

                        // åˆ†é…å†…å­˜
                        this.decoderPtr = mod._malloc(decoderSize);
                        if (!this.decoderPtr) {
                            throw new Error("æ— æ³•åˆ†é…è§£ç å™¨å†…å­˜");
                        }

                        // åˆå§‹åŒ–è§£ç å™¨
                        const err = mod._opus_decoder_init(
                            this.decoderPtr,
                            this.rate,
                            this.channels
                        );

                        if (err < 0) {
                            this.destroy(); // æ¸…ç†èµ„æº
                            throw new Error(`Opusè§£ç å™¨åˆå§‹åŒ–å¤±è´¥: ${err}`);
                        }

                        log("Opusè§£ç å™¨åˆå§‹åŒ–æˆåŠŸ", 'success');
                        return true;
                    },

                    // è§£ç æ–¹æ³•
                    decode: function (opusData) {
                        if (!this.decoderPtr) {
                            if (!this.init()) {
                                throw new Error("è§£ç å™¨æœªåˆå§‹åŒ–ä¸”æ— æ³•åˆå§‹åŒ–");
                            }
                        }

                        try {
                            const mod = this.module;

                            // ä¸ºOpusæ•°æ®åˆ†é…å†…å­˜
                            const opusPtr = mod._malloc(opusData.length);
                            mod.HEAPU8.set(opusData, opusPtr);

                            // ä¸ºPCMè¾“å‡ºåˆ†é…å†…å­˜
                            const pcmPtr = mod._malloc(this.frameSize * 2); // Int16 = 2å­—èŠ‚

                            // è§£ç 
                            const decodedSamples = mod._opus_decode(
                                this.decoderPtr,
                                opusPtr,
                                opusData.length,
                                pcmPtr,
                                this.frameSize,
                                0 // ä¸ä½¿ç”¨FEC
                            );

                            if (decodedSamples < 0) {
                                mod._free(opusPtr);
                                mod._free(pcmPtr);
                                throw new Error(`Opusè§£ç å¤±è´¥: ${decodedSamples}`);
                            }

                            // å¤åˆ¶è§£ç åçš„æ•°æ®
                            const decodedData = new Int16Array(decodedSamples);
                            for (let i = 0; i < decodedSamples; i++) {
                                decodedData[i] = mod.HEAP16[(pcmPtr >> 1) + i];
                            }

                            // é‡Šæ”¾å†…å­˜
                            mod._free(opusPtr);
                            mod._free(pcmPtr);

                            return decodedData;
                        } catch (error) {
                            log(`Opusè§£ç é”™è¯¯: ${error.message}`, 'error');
                            return new Int16Array(0);
                        }
                    },

                    // é”€æ¯æ–¹æ³•
                    destroy: function () {
                        if (this.decoderPtr) {
                            this.module._free(this.decoderPtr);
                            this.decoderPtr = null;
                        }
                    }
                };

                // åˆå§‹åŒ–è§£ç å™¨
                if (!opusDecoder.init()) {
                    throw new Error("Opusè§£ç å™¨åˆå§‹åŒ–å¤±è´¥");
                }

                return opusDecoder;

            } catch (error) {
                log(`Opusè§£ç å™¨åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                opusDecoder = null; // é‡ç½®ä¸ºnullï¼Œä»¥ä¾¿ä¸‹æ¬¡é‡è¯•
                throw error;
            }
        }

        // åˆå§‹åŒ–éŸ³é¢‘å½•åˆ¶å’Œå¤„ç†
        async function initAudio() {
            try {
                // è¯·æ±‚éº¦å…‹é£æƒé™
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000,  // ç¡®ä¿16kHzé‡‡æ ·ç‡
                        channelCount: 1     // ç¡®ä¿å•å£°é“
                    }
                });
                log('å·²è·å–éº¦å…‹é£è®¿é—®æƒé™', 'success');

                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000,  // ç¡®ä¿é‡‡æ ·ç‡ä¸æœåŠ¡å™¨æœŸæœ›çš„ä¸€è‡´
                    latencyHint: 'interactive'
                });
                const source = audioContext.createMediaStreamSource(stream);

                // è·å–å®é™…éŸ³é¢‘è½¨é“è®¾ç½®
                const audioTracks = stream.getAudioTracks();
                if (audioTracks.length > 0) {
                    const track = audioTracks[0];
                    const settings = track.getSettings();
                    log(`å®é™…éº¦å…‹é£è®¾ç½® - é‡‡æ ·ç‡: ${settings.sampleRate || 'æœªçŸ¥'}Hz, å£°é“æ•°: ${settings.channelCount || 'æœªçŸ¥'}`, 'info');
                }

                // åˆ›å»ºåˆ†æå™¨ç”¨äºå¯è§†åŒ–
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                source.connect(analyser);

                // å°è¯•åˆå§‹åŒ–MediaRecorderï¼ŒæŒ‰ä¼˜å…ˆçº§å°è¯•ä¸åŒç¼–ç é€‰é¡¹
                try {
                    // ä¼˜å…ˆå°è¯•ä½¿ç”¨Opusç¼–ç 
                    mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm;codecs=opus',
                        audioBitsPerSecond: 16000
                    });
                    log('å·²åˆå§‹åŒ–MediaRecorder (ä½¿ç”¨Opusç¼–ç )', 'success');
                    log(`é€‰æ‹©çš„ç¼–ç æ ¼å¼: ${mediaRecorder.mimeType}`, 'info');
                } catch (e1) {
                    try {
                        // å¦‚æœOpusä¸æ”¯æŒï¼Œå°è¯•MP3
                        mediaRecorder = new MediaRecorder(stream, {
                            mimeType: 'audio/webm',
                            audioBitsPerSecond: 16000
                        });
                        log('å·²åˆå§‹åŒ–MediaRecorder (ä½¿ç”¨WebMæ ‡å‡†ç¼–ç ï¼ŒOpusä¸æ”¯æŒ)', 'warning');
                        log(`é€‰æ‹©çš„ç¼–ç æ ¼å¼: ${mediaRecorder.mimeType}`, 'info');
                    } catch (e2) {
                        try {
                            // å°è¯•å…¶ä»–å¤‡é€‰æ ¼å¼
                            mediaRecorder = new MediaRecorder(stream, {
                                mimeType: 'audio/ogg;codecs=opus',
                                audioBitsPerSecond: 16000
                            });
                            log('å·²åˆå§‹åŒ–MediaRecorder (ä½¿ç”¨OGG+Opusç¼–ç )', 'warning');
                            log(`é€‰æ‹©çš„ç¼–ç æ ¼å¼: ${mediaRecorder.mimeType}`, 'info');
                        } catch (e3) {
                            // æœ€åä½¿ç”¨é»˜è®¤ç¼–ç 
                            mediaRecorder = new MediaRecorder(stream);
                            log(`å·²åˆå§‹åŒ–MediaRecorder (ä½¿ç”¨é»˜è®¤ç¼–ç : ${mediaRecorder.mimeType})`, 'warning');
                        }
                    }
                }

                // å¤„ç†å½•åˆ¶çš„æ•°æ®
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                // å½•åˆ¶ç»“æŸåå¤„ç†æ•°æ®
                mediaRecorder.onstop = async () => {
                    // åœæ­¢å¯è§†åŒ–
                    if (visualizationRequest) {
                        cancelAnimationFrame(visualizationRequest);
                        visualizationRequest = null;
                    }

                    log(`å½•éŸ³ç»“æŸï¼Œå·²æ”¶é›†çš„éŸ³é¢‘å—æ•°é‡: ${audioChunks.length}`, 'info');
                    if (audioChunks.length === 0) {
                        log('è­¦å‘Šï¼šæ²¡æœ‰æ”¶é›†åˆ°ä»»ä½•éŸ³é¢‘æ•°æ®ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æ˜¯å¦å·¥ä½œæ­£å¸¸', 'error');
                        return;
                    }

                    // åˆ›å»ºå®Œæ•´çš„å½•éŸ³blob
                    const blob = new Blob(audioChunks, { type: audioChunks[0].type });
                    log(`å·²åˆ›å»ºéŸ³é¢‘Blobï¼ŒMIMEç±»å‹: ${audioChunks[0].type}ï¼Œå¤§å°: ${(blob.size / 1024).toFixed(2)} KB`, 'info');

                    // ä¿å­˜åŸå§‹å—ï¼Œä»¥é˜²æ¸…ç©ºåéœ€è¦è°ƒè¯•
                    const chunks = [...audioChunks];
                    audioChunks = [];

                    try {
                        // å°†blobè½¬æ¢ä¸ºArrayBuffer
                        const arrayBuffer = await blob.arrayBuffer();
                        const uint8Array = new Uint8Array(arrayBuffer);

                        log(`å·²è½¬æ¢ä¸ºUint8Arrayï¼Œå‡†å¤‡å‘é€ï¼Œå¤§å°: ${(arrayBuffer.byteLength / 1024).toFixed(2)} KB`, 'info');

                        // æ£€æŸ¥WebSocketçŠ¶æ€
                        if (!websocket) {
                            log('é”™è¯¯ï¼šWebSocketè¿æ¥ä¸å­˜åœ¨', 'error');
                            return;
                        }

                        if (websocket.readyState !== WebSocket.OPEN) {
                            log(`é”™è¯¯ï¼šWebSocketè¿æ¥æœªæ‰“å¼€ï¼Œå½“å‰çŠ¶æ€: ${websocket.readyState}`, 'error');
                            return;
                        }

                        // ç›´æ¥å‘é€äºŒè¿›åˆ¶éŸ³é¢‘æ•°æ® - è¿™æ˜¯æœ€ç®€å•æœ‰æ•ˆçš„æ–¹å¼
                        try {
                            // æ³¨æ„ï¼šå¼€å§‹å’Œç»“æŸæ¶ˆæ¯å·²åœ¨å½•éŸ³å¼€å§‹å’Œç»“æŸæ—¶å‘é€
                            // è¿™é‡Œåªéœ€è¦å‘é€éŸ³é¢‘æ•°æ®
                            await new Promise(resolve => setTimeout(resolve, 50));

                            // å¤„ç†WebMå®¹å™¨æ ¼å¼ï¼Œæå–çº¯Opusæ•°æ®
                            // æœåŠ¡å™¨ä½¿ç”¨opuslib_next.Decoderï¼Œéœ€è¦çº¯Opuså¸§
                            log('æ­£åœ¨å¤„ç†éŸ³é¢‘æ•°æ®ï¼Œæå–çº¯Opuså¸§...', 'info');
                            const opusData = extractOpusFrames(uint8Array);

                            // è®°å½•Opusæ•°æ®å¤§å°
                            log(`å·²æå–Opusæ•°æ®ï¼Œå¤§å°: ${(opusData.byteLength / 1024).toFixed(2)} KB`, 'info');

                            // å‘é€éŸ³é¢‘æ¶ˆæ¯ç¬¬äºŒæ­¥ï¼šäºŒè¿›åˆ¶éŸ³é¢‘æ•°æ®
                            websocket.send(opusData);
                            log(`å·²å‘é€OpuséŸ³é¢‘æ•°æ®: ${(opusData.byteLength / 1024).toFixed(2)} KB`, 'success');
                        } catch (error) {
                            log(`éŸ³é¢‘æ•°æ®å‘é€å¤±è´¥: ${error.message}`, 'error');

                            // å°è¯•ä½¿ç”¨base64ç¼–ç ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                            try {
                                log('å°è¯•ä½¿ç”¨base64ç¼–ç æ–¹å¼å‘é€...', 'info');
                                const base64Data = arrayBufferToBase64(arrayBuffer);
                                const audioDataMessage = {
                                    type: 'audio',
                                    action: 'data',
                                    format: 'opus',
                                    sample_rate: 16000,
                                    channels: 1,
                                    mime_type: chunks[0].type,
                                    encoding: 'base64',
                                    data: base64Data
                                };
                                websocket.send(JSON.stringify(audioDataMessage));
                                log(`å·²ä½¿ç”¨base64ç¼–ç å‘é€éŸ³é¢‘æ•°æ®: ${(arrayBuffer.byteLength / 1024).toFixed(2)} KB`, 'warning');
                            } catch (base64Error) {
                                log(`æ‰€æœ‰æ•°æ®å‘é€æ–¹å¼å‡å¤±è´¥: ${base64Error.message}`, 'error');
                            }
                        }
                    } catch (error) {
                        log(`å¤„ç†å½•éŸ³æ•°æ®é”™è¯¯: ${error.message}`, 'error');
                    }
                };

                // å°è¯•åˆå§‹åŒ–Opusè§£ç å™¨
                try {
                    // æ£€æŸ¥ModuleInstanceæ˜¯å¦å­˜åœ¨ï¼ˆæœ¬åœ°åº“å¯¼å‡ºçš„å…¨å±€å˜é‡ï¼‰
                    if (typeof window.ModuleInstance === 'undefined') {
                        throw new Error('Opusåº“æœªåŠ è½½ï¼ŒModuleInstanceå¯¹è±¡ä¸å­˜åœ¨');
                    }

                    // ç®€å•æµ‹è¯•ModuleInstanceæ˜¯å¦å¯ç”¨
                    if (typeof window.ModuleInstance._opus_decoder_get_size === 'function') {
                        const testSize = window.ModuleInstance._opus_decoder_get_size(1);
                        log(`Opusè§£ç å™¨æµ‹è¯•æˆåŠŸï¼Œè§£ç å™¨å¤§å°: ${testSize} å­—èŠ‚`, 'success');
                    } else {
                        throw new Error('Opusè§£ç å‡½æ•°æœªæ‰¾åˆ°');
                    }
                } catch (err) {
                    log(`Opusè§£ç å™¨åˆå§‹åŒ–è­¦å‘Š: ${err.message}ï¼Œå°†åœ¨éœ€è¦æ—¶é‡è¯•`, 'warning');
                }

                log('éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success');
                return true;
            } catch (error) {
                log(`éŸ³é¢‘åˆå§‹åŒ–é”™è¯¯: ${error.message}`, 'error');
                return false;
            }
        }

        // å¼€å§‹å½•éŸ³
        function startRecording() {
            if (isRecording) return;

            try {
                // æœ€å°å½•éŸ³æ—¶é•¿æç¤º
                log('è¯·è‡³å°‘å½•åˆ¶1-2ç§’é’Ÿçš„éŸ³é¢‘ï¼Œç¡®ä¿é‡‡é›†åˆ°è¶³å¤Ÿæ•°æ®', 'info');

                // è·å–æœåŠ¡å™¨ç±»å‹ - ä»URLåˆ¤æ–­
                const serverUrl = serverUrlInput.value.trim();
                let isXiaozhiNative = false;

                // æ£€æŸ¥æ˜¯å¦æ˜¯å°æ™ºåŸç”ŸæœåŠ¡å™¨ (æ ¹æ®URLç‰¹å¾åˆ¤æ–­)
                if (serverUrl.includes('xiaozhi') || serverUrl.includes('localhost') || serverUrl.includes('127.0.0.1')) {
                    isXiaozhiNative = true;
                    log('æ£€æµ‹åˆ°å°æ™ºåŸç”ŸæœåŠ¡å™¨ï¼Œä½¿ç”¨æ ‡å‡†listenåè®®', 'info');
                }

                // ä½¿ç”¨ç›´æ¥PCMå½•éŸ³å’Œlibopusç¼–ç çš„æ–¹å¼
                startDirectRecording();
            } catch (error) {
                log(`å½•éŸ³å¯åŠ¨é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (!isRecording) return;

            try {
                // ä½¿ç”¨ç›´æ¥PCMå½•éŸ³åœæ­¢
                stopDirectRecording();
            } catch (error) {
                log(`åœæ­¢å½•éŸ³é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // è¿æ¥WebSocketæœåŠ¡å™¨
        async function connectToServer() {
            const url = serverUrlInput.value.trim();
            if (url === '') return;

            try {
                // è·å–å¹¶éªŒè¯é…ç½®
                const config = getConfig();
                if (!validateConfig(config)) {
                    return;
                }

                // æ£€æŸ¥URLæ ¼å¼
                if (!url.startsWith('ws://') && !url.startsWith('wss://')) {
                    log('URLæ ¼å¼é”™è¯¯ï¼Œå¿…é¡»ä»¥ws://æˆ–wss://å¼€å¤´', 'error');
                    return;
                }

                // å…ˆæ£€æŸ¥OTAçŠ¶æ€
                log('æ­£åœ¨æ£€æŸ¥OTAçŠ¶æ€...', 'info');
                const otaUrl = document.getElementById('otaUrl').value.trim();
                localStorage.setItem('otaUrl', otaUrl);
                localStorage.setItem('wsUrl', url);
                try {
                    const otaResponse = await fetch(otaUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Device-Id': config.deviceId,
                            'Client-Id': config.clientId
                        },
                        body: JSON.stringify({
                            "version": 0,
                            "uuid": "",
                            "application": {
                                "name": "xiaozhi-web-test",
                                "version": "1.0.0",
                                "compile_time": "2025-04-16 10:00:00",
                                "idf_version": "4.4.3",
                                "elf_sha256": "1234567890abcdef1234567890abcdef1234567890abcdef"
                            },
                            "ota": {
                                "label": "xiaozhi-web-test",
                            },
                            "board": {
                                "type": "xiaozhi-web-test",
                                "ssid": "xiaozhi-web-test",
                                "rssi": 0,
                                "channel": 0,
                                "ip": "192.168.1.1",
                                "mac": config.deviceMac
                            },
                            "flash_size": 0,
                            "minimum_free_heap_size": 0,
                            "mac_address": config.deviceMac,
                            "chip_model_name": "",
                            "chip_info": {
                                "model": 0,
                                "cores": 0,
                                "revision": 0,
                                "features": 0
                            },
                            "partition_table": [
                                {
                                    "label": "",
                                    "type": 0,
                                    "subtype": 0,
                                    "address": 0,
                                    "size": 0
                                }
                            ]
                        })
                    });

                    if (!otaResponse.ok) {
                        throw new Error(`OTAæ£€æŸ¥å¤±è´¥: ${otaResponse.status} ${otaResponse.statusText}`);
                    }

                    const otaResult = await otaResponse.json();
                    log(`OTAæ£€æŸ¥ç»“æœ: ${JSON.stringify(otaResult)}`, 'info');

                    log('OTAæ£€æŸ¥é€šè¿‡ï¼Œå¼€å§‹è¿æ¥WebSocket...', 'success');
                    if (otaStatus) {
                    otaStatus.textContent = 'otaå·²è¿æ¥';
                    otaStatus.style.color = 'green';
                }
                } catch (error) {
                    log(`OTAæ£€æŸ¥é”™è¯¯: ${error.message}`, 'error');
                    if (otaStatus) {
                        otaStatus.textContent = 'otaæœªè¿æ¥';
                        otaStatus.style.color = 'red';
                    }
                }

                // ä½¿ç”¨è‡ªå®šä¹‰WebSocketå®ç°ä»¥æ·»åŠ è®¤è¯å¤´ä¿¡æ¯
                let connUrl = new URL(url);

                // æ·»åŠ è®¤è¯å‚æ•°
                connUrl.searchParams.append('device-id', config.deviceId);
                connUrl.searchParams.append('client-id', config.clientId);

                log(`æ­£åœ¨è¿æ¥: ${connUrl.toString()}`, 'info');
                websocket = new WebSocket(connUrl.toString());

                // è®¾ç½®æ¥æ”¶äºŒè¿›åˆ¶æ•°æ®çš„ç±»å‹ä¸ºArrayBuffer
                websocket.binaryType = 'arraybuffer';

                websocket.onopen = async () => {
                    log(`å·²è¿æ¥åˆ°æœåŠ¡å™¨: ${url}`, 'success');
                    if (connectionStatus) {
                    connectionStatus.textContent = 'wså·²è¿æ¥';
                    connectionStatus.style.color = 'green';
                }

                    // è¿æ¥æˆåŠŸåå‘é€helloæ¶ˆæ¯
                    await sendHelloMessage();

                    connectButton.textContent = 'æ–­å¼€';
                    connectButton.removeEventListener('click', connectToServer);
                    connectButton.addEventListener('click', disconnectFromServer);
                    // connectButton.onclick = disconnectFromServer;
                    messageInput.disabled = false;
                    sendTextButton.disabled = false;

                    const audioInitialized = await initAudio();
                    if (audioInitialized) {
                        recordButton.disabled = false;
                    }
                };

                websocket.onclose = () => {
                    log('å·²æ–­å¼€è¿æ¥', 'info');
                    if (connectionStatus) {
                    connectionStatus.textContent = 'wså·²æ–­å¼€';
                    connectionStatus.style.color = 'red';
                }

                    connectButton.textContent = 'è¿æ¥';
                    connectButton.removeEventListener('click', disconnectFromServer);
                    connectButton.addEventListener('click', connectToServer);
                    // connectButton.onclick = connectToServer;
                    messageInput.disabled = true;
                    sendTextButton.disabled = true;
                    recordButton.disabled = true;
                    stopButton.disabled = true;
                };

                websocket.onerror = (error) => {
                    log(`WebSocketé”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    if (connectionStatus) {
                          connectionStatus.textContent = 'wsæœªè¿æ¥';
                          connectionStatus.style.color = 'red';
                      }
                };

                websocket.onmessage = function (event) {
                    try {
                        // æ£€æŸ¥æ˜¯å¦ä¸ºæ–‡æœ¬æ¶ˆæ¯
                        if (typeof event.data === 'string') {
                            const message = JSON.parse(event.data);

                            if (message.type === 'hello') {
                                log(`æœåŠ¡å™¨å›åº”ï¼š${JSON.stringify(message, null, 2)}`, 'success');
                            } else if (message.type === 'tts') {
                                // TTSçŠ¶æ€æ¶ˆæ¯
                                if (message.state === 'start') {
                                    log('æœåŠ¡å™¨å¼€å§‹å‘é€è¯­éŸ³', 'info');
                                } else if (message.state === 'sentence_start') {
                                    log(`æœåŠ¡å™¨å‘é€è¯­éŸ³æ®µ: ${message.text}`, 'info');
                                    // æ·»åŠ æ–‡æœ¬åˆ°ä¼šè¯è®°å½•
                                    if (message.text) {
                                        addMessage(message.text);
                                    }
                                } else if (message.state === 'sentence_end') {
                                    log(`è¯­éŸ³æ®µç»“æŸ: ${message.text}`, 'info');
                                } else if (message.state === 'stop') {
                                    log('æœåŠ¡å™¨è¯­éŸ³ä¼ è¾“ç»“æŸ', 'info');
                                    // ç»“æŸåæ›´æ–°UIçŠ¶æ€
                                    if (recordButton.disabled) {
                                        recordButton.disabled = false;
                                        recordButton.textContent = 'å¼€å§‹å½•éŸ³';
                                        recordButton.classList.remove('recording');
                                    }
                                }
                            } else if (message.type === 'audio') {
                                // éŸ³é¢‘æ§åˆ¶æ¶ˆæ¯
                                log(`æ”¶åˆ°éŸ³é¢‘æ§åˆ¶æ¶ˆæ¯: ${JSON.stringify(message)}`, 'info');
                            } else if (message.type === 'stt') {
                                // è¯­éŸ³è¯†åˆ«ç»“æœ
                                log(`è¯†åˆ«ç»“æœ: ${message.text}`, 'info');
                                // æ·»åŠ è¯†åˆ«ç»“æœåˆ°ä¼šè¯è®°å½•ï¼Œä½†ä¸æ˜¾ç¤ºæ™®é€šæ¶ˆæ¯
                                addMessage(` ${message.text}`, true);
                            } else if (message.type === 'llm') {
                                // å¤§æ¨¡å‹å›å¤
                                log(`å¤§æ¨¡å‹å›å¤: ${message.text}`, 'info');
                                // æ·»åŠ å¤§æ¨¡å‹å›å¤åˆ°ä¼šè¯è®°å½•ï¼Œè¿‡æ»¤æ‰emojiè¡¨æƒ…
                                if (message.text) {
                                    // ç§»é™¤æ‰€æœ‰emojiè¡¨æƒ…ç¬¦å·
                                    const cleanText = message.text.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '').trim();
                                    if (cleanText) {
                                        addMessage(cleanText);
                                    }
                                }
                            }else if (message.type === 'mcp') {
                                const payload = message.payload || {};
                                log(`æœåŠ¡å™¨ä¸‹å‘: ${JSON.stringify(message)}`, 'info');
                                if (payload) {
                                    // æ¨¡æ‹Ÿå°æ™ºå®¢æˆ·ç«¯è¡Œä¸º
                                    if(payload.method === 'tools/list'){
                                        const replay_message = JSON.stringify({"session_id":"","type":"mcp","payload":{"jsonrpc":"2.0","id":2,"result":{"tools":[{"name":"self.get_device_status","description":"Provides the real-time information of the device, including the current status of the audio speaker, screen, battery, network, etc.\nUse this tool for: \n1. Answering questions about current condition (e.g. what is the current volume of the audio speaker?)\n2. As the first step to control the device (e.g. turn up / down the volume of the audio speaker, etc.)","inputSchema":{"type":"object","properties":{}}},{"name":"self.audio_speaker.set_volume","description":"Set the volume of the audio speaker. If the current volume is unknown, you must call `self.get_device_status` tool first and then call this tool.","inputSchema":{"type":"object","properties":{"volume":{"type":"integer","minimum":0,"maximum":100}},"required":["volume"]}},{"name":"self.screen.set_brightness","description":"Set the brightness of the screen.","inputSchema":{"type":"object","properties":{"brightness":{"type":"integer","minimum":0,"maximum":100}},"required":["brightness"]}},{"name":"self.screen.set_theme","description":"Set the theme of the screen. The theme can be 'light' or 'dark'.","inputSchema":{"type":"object","properties":{"theme":{"type":"string"}},"required":["theme"]}}]}}})
                                        websocket.send(replay_message);
                                        log(`å›å¤MCPæ¶ˆæ¯: ${replay_message}`, 'info');
                                    } else if(payload.method === 'tools/call'){
                                        // æ¨¡æ‹Ÿå›å¤
                                        const replay_message = JSON.stringify({"session_id":"9f261599","type":"mcp","payload":{"jsonrpc":"2.0","id": payload.id,"result":{"content":[{"type":"text","text":"true"}],"isError":false}}})
                                        websocket.send(replay_message);
                                        log(`å›å¤MCPæ¶ˆæ¯: ${replay_message}`, 'info');
                                    }
                                }
                                
                            } else {
                                // æœªçŸ¥æ¶ˆæ¯ç±»å‹
                                log(`æœªçŸ¥æ¶ˆæ¯ç±»å‹: ${message.type}`, 'info');
                                addMessage(JSON.stringify(message, null, 2));
                            }
                        } else {
                            // å¤„ç†äºŒè¿›åˆ¶æ•°æ® - å…¼å®¹å¤šç§äºŒè¿›åˆ¶æ ¼å¼
                            handleBinaryMessage(event.data);
                        }
                    } catch (error) {
                        log(`WebSocketæ¶ˆæ¯å¤„ç†é”™è¯¯: ${error.message}`, 'error');
                        // éJSONæ ¼å¼æ–‡æœ¬æ¶ˆæ¯ç›´æ¥æ˜¾ç¤º
                        if (typeof event.data === 'string') {
                            addMessage(event.data);
                        }
                    }
                };

                if (connectionStatus) {
                connectionStatus.textContent = 'wsæœªè¿æ¥';
                connectionStatus.style.color = 'orange';
            }
            } catch (error) {
                log(`è¿æ¥é”™è¯¯: ${error.message}`, 'error');
                connectionStatus.textContent = 'wsæœªè¿æ¥';
            }
        }

        // å‘é€helloæ¡æ‰‹æ¶ˆæ¯
        async function sendHelloMessage() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) return;

            try {
                const config = getConfig();

                // è®¾ç½®è®¾å¤‡ä¿¡æ¯
                const helloMessage = {
                    type: 'hello',
                    device_id: config.deviceId,
                    device_name: config.deviceName,
                    device_mac: config.deviceMac,
                    token: config.token,
                    features: {
                        mcp: true
                    }
                };

                log('å‘é€helloæ¡æ‰‹æ¶ˆæ¯', 'info');
                websocket.send(JSON.stringify(helloMessage));

                // ç­‰å¾…æœåŠ¡å™¨å“åº”
                return new Promise(resolve => {
                    // 5ç§’è¶…æ—¶
                    const timeout = setTimeout(() => {
                        log('ç­‰å¾…helloå“åº”è¶…æ—¶', 'error');
                        log('æç¤º: è¯·å°è¯•ç‚¹å‡»"æµ‹è¯•è®¤è¯"æŒ‰é’®è¿›è¡Œè¿æ¥æ’æŸ¥', 'info');
                        resolve(false);
                    }, 5000);

                    // ä¸´æ—¶ç›‘å¬ä¸€æ¬¡æ¶ˆæ¯ï¼Œæ¥æ”¶helloå“åº”
                    const onMessageHandler = (event) => {
                        try {
                            const response = JSON.parse(event.data);
                            if (response.type === 'hello' && response.session_id) {
                                log(`æœåŠ¡å™¨æ¡æ‰‹æˆåŠŸï¼Œä¼šè¯ID: ${response.session_id}`, 'success');
                                clearTimeout(timeout);
                                websocket.removeEventListener('message', onMessageHandler);
                                resolve(true);
                            }
                        } catch (e) {
                            // å¿½ç•¥éJSONæ¶ˆæ¯
                        }
                    };

                    websocket.addEventListener('message', onMessageHandler);
                });
            } catch (error) {
                log(`å‘é€helloæ¶ˆæ¯é”™è¯¯: ${error.message}`, 'error');
                return false;
            }
        }

        // æ–­å¼€WebSocketè¿æ¥
        function disconnectFromServer() {
            if (!websocket) return;

            websocket.close();
            stopRecording();
        }

        // å‘é€æ–‡æœ¬æ¶ˆæ¯
        function sendTextMessage() {
            const message = messageInput.value.trim();
            if (message === '' || !websocket || websocket.readyState !== WebSocket.OPEN) return;

            audioBufferQueue = [];
            isAudioBuffering = false;
            isAudioPlaying = false;

            try {
                // ç›´æ¥å‘é€listenæ¶ˆæ¯ï¼Œä¸éœ€è¦é‡å¤å‘é€hello
                const listenMessage = {
                    type: 'listen',
                    mode: 'manual',
                    state: 'detect',
                    text: message
                };

                websocket.send(JSON.stringify(listenMessage));
                // ä¸æ˜¾ç¤ºæ™®é€šæ¶ˆæ¯ï¼Œåªæ˜¾ç¤ºå¸¦æœ‰[è¯­éŸ³è¯†åˆ«]æ ‡è¯†çš„æ¶ˆæ¯
                log(`å‘é€æ–‡æœ¬æ¶ˆæ¯: ${message}`, 'info');

                messageInput.value = '';
            } catch (error) {
                log(`å‘é€æ¶ˆæ¯é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // å‘é€å¿«æ·æ¶ˆæ¯
        function sendQuickMessage(message) {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                log('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                return;
            }

            audioBufferQueue = [];
            isAudioBuffering = false;
            isAudioPlaying = false;

            try {
                // ç›´æ¥å‘é€listenæ¶ˆæ¯
                const listenMessage = {
                    type: 'listen',
                    mode: 'manual',
                    state: 'detect',
                    text: message
                };

                websocket.send(JSON.stringify(listenMessage));
                log(`å‘é€å¿«æ·æ¶ˆæ¯: ${message}`, 'info');
            } catch (error) {
                log(`å‘é€å¿«æ·æ¶ˆæ¯é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // ç”ŸæˆéšæœºMACåœ°å€
        function generateRandomMac() {
            const hexDigits = '0123456789ABCDEF';
            let mac = '';
            for (let i = 0; i < 6; i++) {
                if (i > 0) mac += ':';
                for (let j = 0; j < 2; j++) {
                    mac += hexDigits.charAt(Math.floor(Math.random() * 16));
                }
            }
            return mac;
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            connectButton.addEventListener('click', connectToServer);
            document.getElementById('authTestButton').addEventListener('click', testAuthentication);

            // ä»localStorageåŠ è½½MACåœ°å€ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”Ÿæˆæ–°çš„
            const deviceMacInput = document.getElementById('deviceMac');
            let savedMac = localStorage.getItem('deviceMac');
            if (!savedMac) {
                savedMac = generateRandomMac();
                localStorage.setItem('deviceMac', savedMac);
            }
            deviceMacInput.value = savedMac;

            const savedOtaUrl = localStorage.getItem('otaUrl');
            if (savedOtaUrl) {
                document.getElementById('otaUrl').value = savedOtaUrl;
            }

            const savedWsUrl = localStorage.getItem('wsUrl');
            if (savedWsUrl) {
                document.getElementById('serverUrl').value = savedWsUrl;
            }

            // è®¾ç½®é¢æ¿åˆ‡æ¢
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsPanel = document.getElementById('settingsPanel');
            if (settingsBtn && settingsPanel) {
                settingsBtn.addEventListener('click', () => {
                    settingsPanel.classList.toggle('open');
                });
            }

            // è¾“å…¥æ ‡ç­¾é¡µåˆ‡æ¢
            const inputTabs = document.querySelectorAll('.input-tab');
            inputTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰æ ‡ç­¾é¡µçš„activeç±»
                    inputTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.input-content').forEach(c => c.classList.remove('active'));

                    // æ·»åŠ å½“å‰æ ‡ç­¾é¡µçš„activeç±»
                    tab.classList.add('active');
                    const tabName = tab.getAttribute('data-tab');
                    document.getElementById(`${tabName}InputContent`).classList.add('active');
                    
                    // æ›´æ–°æ¬¢è¿æ¶ˆæ¯çš„æç¤ºæ–‡æœ¬
                    const welcomeMessage = document.querySelector('.welcome-message p');
                    if (welcomeMessage) {
                        if (tabName === 'text') {
                            welcomeMessage.textContent = 'ç‚¹å‡»æ–‡æœ¬æ¡†è¾“å…¥';
                        } else if (tabName === 'voice') {
                            welcomeMessage.textContent = 'ç‚¹å‡»éº¦å…‹é£å¼€å§‹å¯¹è¯';
                        }
                    }
                    
                    // å¦‚æœåˆ‡æ¢åˆ°æ–‡æœ¬è¾“å…¥æ¨¡å¼ï¼Œæ¸…ç©ºéŸ³é¢‘ç¼“å†²é˜Ÿåˆ—ï¼Œé˜²æ­¢å†å²è¯­éŸ³è¢«æ’­æ”¾
                    if (tabName === 'text') {
                        if (audioBufferQueue.length > 0) {
                            log('åˆ‡æ¢åˆ°æ–‡æœ¬è¾“å…¥æ¨¡å¼ï¼Œæ¸…ç©ºéŸ³é¢‘ç¼“å†²é˜Ÿåˆ—', 'info');
                            audioBufferQueue = [];
                        }
                        // åœæ­¢æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘
                        if (isAudioPlaying || isAudioBuffering) {
                            log('åˆ‡æ¢åˆ°æ–‡æœ¬è¾“å…¥æ¨¡å¼ï¼Œåœæ­¢éŸ³é¢‘æ’­æ”¾', 'info');
                            isAudioPlaying = false;
                            isAudioBuffering = false;
                            if (streamingContext && streamingContext.source) {
                                streamingContext.source.stop();
                                streamingContext.source = null;
                            }
                            streamingContext = null;
                        }
                    }
                });
            });

            sendTextButton.addEventListener('click', sendTextMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendTextMessage();
                }
            });

            recordButton.addEventListener('click', () => {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            });

            window.addEventListener('resize', initVisualizer);
        }

        // æµ‹è¯•è®¤è¯
        async function testAuthentication() {
            log('å¼€å§‹æµ‹è¯•è®¤è¯...', 'info');

            const config = getConfig();

            // æ˜¾ç¤ºæœåŠ¡å™¨é…ç½®
            log('-------- æœåŠ¡å™¨è®¤è¯é…ç½®æ£€æŸ¥ --------', 'info');
            log('è¯·ç¡®è®¤config.yamlä¸­çš„authé…ç½®ï¼š', 'info');
            log('1. server.auth.enabled ä¸º false æˆ–æœåŠ¡å™¨å·²æ­£ç¡®é…ç½®è®¤è¯', 'info');
            log('2. å¦‚æœå¯ç”¨äº†è®¤è¯ï¼Œè¯·ç¡®è®¤ä½¿ç”¨äº†æ­£ç¡®çš„token', 'info');
            log(`3. æˆ–è€…åœ¨allowed_devicesä¸­æ·»åŠ äº†æµ‹è¯•è®¾å¤‡MACï¼š${config.deviceMac}`, 'info');

            const serverUrl = serverUrlInput.value.trim();
            if (!serverUrl) {
                log('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€', 'error');
                return;
            }

            // æµ‹è¯•è¿æ¥
            log('å°è¯•ä¸åŒè®¤è¯å‚æ•°çš„è¿æ¥ï¼š', 'info');

            // æµ‹è¯•1: æ— å‚æ•°è¿æ¥
            try {
                log('æµ‹è¯•1: å°è¯•æ— å‚æ•°è¿æ¥...', 'info');
                const ws1 = new WebSocket(serverUrl);

                ws1.onopen = () => {
                    log('æµ‹è¯•1æˆåŠŸ: æ— å‚æ•°å¯è¿æ¥ï¼ŒæœåŠ¡å™¨å¯èƒ½æ²¡æœ‰å¯ç”¨è®¤è¯', 'success');
                    ws1.close();
                };

                ws1.onerror = (error) => {
                    log('æµ‹è¯•1å¤±è´¥: æ— å‚æ•°è¿æ¥è¢«æ‹’ç»ï¼ŒæœåŠ¡å™¨å¯èƒ½å¯ç”¨äº†è®¤è¯', 'error');
                };

                // 5ç§’åå…³é—­æµ‹è¯•è¿æ¥
                setTimeout(() => {
                    if (ws1.readyState === WebSocket.CONNECTING || ws1.readyState === WebSocket.OPEN) {
                        ws1.close();
                    }
                }, 5000);
            } catch (error) {
                log(`æµ‹è¯•1å‡ºé”™: ${error.message}`, 'error');
            }

            // æµ‹è¯•2: å¸¦å‚æ•°è¿æ¥
            setTimeout(async () => {
                try {
                    log('æµ‹è¯•2: å°è¯•å¸¦tokenå‚æ•°è¿æ¥...', 'info');

                    let url = new URL(serverUrl);
                    url.searchParams.append('token', config.token);
                    url.searchParams.append('device_id', config.deviceId);
                    url.searchParams.append('device_mac', config.deviceMac);

                    const ws2 = new WebSocket(url.toString());

                    ws2.onopen = () => {
                        log('æµ‹è¯•2æˆåŠŸ: å¸¦tokenå‚æ•°å¯è¿æ¥', 'success');

                        // å°è¯•å‘é€helloæ¶ˆæ¯
                        const helloMsg = {
                            type: 'hello',
                            device_id: config.deviceId,
                            device_mac: config.deviceMac,
                            token: config.token
                        };

                        ws2.send(JSON.stringify(helloMsg));
                        log('å·²å‘é€helloæµ‹è¯•æ¶ˆæ¯', 'info');

                        // ç›‘å¬å“åº”
                        ws2.onmessage = (event) => {
                            try {
                                const response = JSON.parse(event.data);
                                if (response.type === 'hello' && response.session_id) {
                                    log(`æµ‹è¯•å®Œå…¨æˆåŠŸ! æ”¶åˆ°helloå“åº”ï¼Œä¼šè¯ID: ${response.session_id}`, 'success');
                                    ws2.close();
                                }
                            } catch (e) {
                                log(`æ”¶åˆ°éJSONå“åº”: ${event.data}`, 'info');
                            }
                        };

                        // 5ç§’åå…³é—­
                        setTimeout(() => ws2.close(), 5000);
                    };

                    ws2.onerror = (error) => {
                        log('æµ‹è¯•2å¤±è´¥: å¸¦tokenå‚æ•°è¿æ¥è¢«æ‹’ç»', 'error');
                        log('è¯·æ£€æŸ¥tokenæ˜¯å¦æ­£ç¡®ï¼Œæˆ–æœåŠ¡å™¨æ˜¯å¦æ¥å—URLå‚æ•°è®¤è¯', 'error');
                    };
                } catch (error) {
                    log(`æµ‹è¯•2å‡ºé”™: ${error.message}`, 'error');
                }
            }, 6000);

            log('è®¤è¯æµ‹è¯•å·²å¯åŠ¨ï¼Œè¯·æŸ¥çœ‹æµ‹è¯•ç»“æœ...', 'info');
        }

        // å¸®åŠ©å‡½æ•°ï¼šArrayBufferè½¬Base64
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        // ä½¿ç”¨libopusåˆ›å»ºä¸€ä¸ªOpusç¼–ç å™¨
        let opusEncoder = null;
        function initOpusEncoder() {
            try {
                if (opusEncoder) {
                    return true; // å·²ç»åˆå§‹åŒ–è¿‡
                }

                if (!window.ModuleInstance) {
                    log('æ— æ³•åˆ›å»ºOpusç¼–ç å™¨ï¼šModuleInstanceä¸å¯ç”¨', 'error');
                    return false;
                }

                // åˆå§‹åŒ–ä¸€ä¸ªOpusç¼–ç å™¨
                const mod = window.ModuleInstance;
                const sampleRate = 16000; // 16kHzé‡‡æ ·ç‡
                const channels = 1;       // å•å£°é“
                const application = 2048; // OPUS_APPLICATION_VOIP = 2048

                // åˆ›å»ºç¼–ç å™¨
                opusEncoder = {
                    channels: channels,
                    sampleRate: sampleRate,
                    frameSize: 960, // 60ms @ 16kHz = 60 * 16 = 960 samples
                    maxPacketSize: 4000, // æœ€å¤§åŒ…å¤§å°
                    module: mod,

                    // åˆå§‹åŒ–ç¼–ç å™¨
                    init: function () {
                        try {
                            // è·å–ç¼–ç å™¨å¤§å°
                            const encoderSize = mod._opus_encoder_get_size(this.channels);
                            log(`Opusç¼–ç å™¨å¤§å°: ${encoderSize}å­—èŠ‚`, 'info');

                            // åˆ†é…å†…å­˜
                            this.encoderPtr = mod._malloc(encoderSize);
                            if (!this.encoderPtr) {
                                throw new Error("æ— æ³•åˆ†é…ç¼–ç å™¨å†…å­˜");
                            }

                            // åˆå§‹åŒ–ç¼–ç å™¨
                            const err = mod._opus_encoder_init(
                                this.encoderPtr,
                                this.sampleRate,
                                this.channels,
                                application
                            );

                            if (err < 0) {
                                throw new Error(`Opusç¼–ç å™¨åˆå§‹åŒ–å¤±è´¥: ${err}`);
                            }

                            // è®¾ç½®ä½ç‡ (16kbps)
                            mod._opus_encoder_ctl(this.encoderPtr, 4002, 16000); // OPUS_SET_BITRATE

                            // è®¾ç½®å¤æ‚åº¦ (0-10, è¶Šé«˜è´¨é‡è¶Šå¥½ä½†CPUä½¿ç”¨è¶Šå¤š)
                            mod._opus_encoder_ctl(this.encoderPtr, 4010, 5);     // OPUS_SET_COMPLEXITY

                            // è®¾ç½®ä½¿ç”¨DTX (ä¸ä¼ è¾“é™éŸ³å¸§)
                            mod._opus_encoder_ctl(this.encoderPtr, 4016, 1);     // OPUS_SET_DTX

                            log("Opusç¼–ç å™¨åˆå§‹åŒ–æˆåŠŸ", 'success');
                            return true;
                        } catch (error) {
                            if (this.encoderPtr) {
                                mod._free(this.encoderPtr);
                                this.encoderPtr = null;
                            }
                            log(`Opusç¼–ç å™¨åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                            return false;
                        }
                    },

                    // ç¼–ç PCMæ•°æ®ä¸ºOpus
                    encode: function (pcmData) {
                        if (!this.encoderPtr) {
                            if (!this.init()) {
                                return null;
                            }
                        }

                        try {
                            const mod = this.module;

                            // ä¸ºPCMæ•°æ®åˆ†é…å†…å­˜
                            const pcmPtr = mod._malloc(pcmData.length * 2); // 2å­—èŠ‚/int16

                            // å°†PCMæ•°æ®å¤åˆ¶åˆ°HEAP
                            for (let i = 0; i < pcmData.length; i++) {
                                mod.HEAP16[(pcmPtr >> 1) + i] = pcmData[i];
                            }

                            // ä¸ºè¾“å‡ºåˆ†é…å†…å­˜
                            const outPtr = mod._malloc(this.maxPacketSize);

                            // è¿›è¡Œç¼–ç 
                            const encodedLen = mod._opus_encode(
                                this.encoderPtr,
                                pcmPtr,
                                this.frameSize,
                                outPtr,
                                this.maxPacketSize
                            );

                            if (encodedLen < 0) {
                                throw new Error(`Opusç¼–ç å¤±è´¥: ${encodedLen}`);
                            }

                            // å¤åˆ¶ç¼–ç åçš„æ•°æ®
                            const opusData = new Uint8Array(encodedLen);
                            for (let i = 0; i < encodedLen; i++) {
                                opusData[i] = mod.HEAPU8[outPtr + i];
                            }

                            // é‡Šæ”¾å†…å­˜
                            mod._free(pcmPtr);
                            mod._free(outPtr);

                            return opusData;
                        } catch (error) {
                            log(`Opusç¼–ç å‡ºé”™: ${error.message}`, 'error');
                            return null;
                        }
                    },

                    // é”€æ¯ç¼–ç å™¨
                    destroy: function () {
                        if (this.encoderPtr) {
                            this.module._free(this.encoderPtr);
                            this.encoderPtr = null;
                        }
                    }
                };

                const result = opusEncoder.init();
                return result;
            } catch (error) {
                log(`åˆ›å»ºOpusç¼–ç å™¨å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            initVisualizer();
            initEventListeners();

            // æ£€æŸ¥libopus.jsæ˜¯å¦æ­£ç¡®åŠ è½½
            checkOpusLoaded();

            // åˆå§‹åŒ–Opusç¼–ç å™¨
            initOpusEncoder();

            // é¢„åŠ è½½Opusè§£ç å™¨
            log('é¢„åŠ è½½Opusè§£ç å™¨...', 'info');
            initOpusDecoder().then(() => {
                log('Opusè§£ç å™¨é¢„åŠ è½½æˆåŠŸ', 'success');
            }).catch(error => {
                log(`Opusè§£ç å™¨é¢„åŠ è½½å¤±è´¥: ${error.message}ï¼Œå°†åœ¨éœ€è¦æ—¶é‡è¯•`, 'warning');
            });

            // è§£ææ¬¢è¿æ¶ˆæ¯çš„Markdownå†…å®¹
            const welcomeMessageContent = document.querySelector('.welcome-message .message-content');
            if (welcomeMessageContent) {
                try {
                    const originalText = welcomeMessageContent.textContent;
                    welcomeMessageContent.innerHTML = marked.parse(originalText);
                } catch (error) {
                    log(`æ¬¢è¿æ¶ˆæ¯Markdownè§£æå¤±è´¥: ${error.message}`, 'warning');
                }
            }

            // è‡ªåŠ¨è¿æ¥åˆ°æœåŠ¡å™¨
            setTimeout(() => {
                log('æ­£åœ¨è‡ªåŠ¨è¿æ¥åˆ°æœåŠ¡å™¨...', 'info');
                connectToServer();
            }, 2000); // å»¶è¿Ÿ2ç§’åè‡ªåŠ¨è¿æ¥ï¼Œç¡®ä¿åˆå§‹åŒ–å®Œæˆ
        }

        // PCMå½•éŸ³å¤„ç†å™¨ä»£ç  - ä¼šè¢«æ³¨å…¥åˆ°AudioWorkletä¸­
        const audioProcessorCode = `
            class AudioRecorderProcessor extends AudioWorkletProcessor {
                constructor() {
                    super();
                    this.buffers = [];
                    this.frameSize = 960; // 60ms @ 16kHz = 960 samples
                    this.buffer = new Int16Array(this.frameSize);
                    this.bufferIndex = 0;
                    this.isRecording = false;

                    // ç›‘å¬æ¥è‡ªä¸»çº¿ç¨‹çš„æ¶ˆæ¯
                    this.port.onmessage = (event) => {
                        if (event.data.command === 'start') {
                            this.isRecording = true;
                            this.port.postMessage({ type: 'status', status: 'started' });
                        } else if (event.data.command === 'stop') {
                            this.isRecording = false;

                            // å‘é€å‰©ä½™çš„ç¼“å†²åŒº
                            if (this.bufferIndex > 0) {
                                const finalBuffer = this.buffer.slice(0, this.bufferIndex);
                                this.port.postMessage({
                                    type: 'buffer',
                                    buffer: finalBuffer
                                });
                                this.bufferIndex = 0;
                            }

                            this.port.postMessage({ type: 'status', status: 'stopped' });
                        }
                    };
                }

                process(inputs, outputs, parameters) {
                    if (!this.isRecording) return true;

                    const input = inputs[0][0]; // è·å–ç¬¬ä¸€ä¸ªè¾“å…¥é€šé“
                    if (!input) return true;

                    // å°†æµ®ç‚¹é‡‡æ ·è½¬æ¢ä¸º16ä½æ•´æ•°å¹¶å­˜å‚¨
                    for (let i = 0; i < input.length; i++) {
                        if (this.bufferIndex >= this.frameSize) {
                            // ç¼“å†²åŒºå·²æ»¡ï¼Œå‘é€ç»™ä¸»çº¿ç¨‹å¹¶é‡ç½®
                            this.port.postMessage({
                                type: 'buffer',
                                buffer: this.buffer.slice(0)
                            });
                            this.bufferIndex = 0;
                        }

                        // è½¬æ¢ä¸º16ä½æ•´æ•° (-32768åˆ°32767)
                        this.buffer[this.bufferIndex++] = Math.max(-32768, Math.min(32767, Math.floor(input[i] * 32767)));
                    }

                    return true;
                }
            }

            registerProcessor('audio-recorder-processor', AudioRecorderProcessor);
        `;

        // åˆ›å»ºéŸ³é¢‘å¤„ç†å™¨
        async function createAudioProcessor() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000,
                    latencyHint: 'interactive'
                });
            }

            try {
                // æ£€æŸ¥æ˜¯å¦æ”¯æŒAudioWorklet
                if (audioContext.audioWorklet) {
                    // æ³¨å†ŒéŸ³é¢‘å¤„ç†å™¨
                    const blob = new Blob([audioProcessorCode], { type: 'application/javascript' });
                    const url = URL.createObjectURL(blob);
                    await audioContext.audioWorklet.addModule(url);
                    URL.revokeObjectURL(url);

                    // åˆ›å»ºéŸ³é¢‘å¤„ç†èŠ‚ç‚¹
                    const audioProcessor = new AudioWorkletNode(audioContext, 'audio-recorder-processor');

                    // è®¾ç½®éŸ³é¢‘å¤„ç†æ¶ˆæ¯å¤„ç†
                    audioProcessor.port.onmessage = (event) => {
                        if (event.data.type === 'buffer') {
                            // æ”¶åˆ°PCMç¼“å†²åŒºæ•°æ®
                            processPCMBuffer(event.data.buffer);
                        }
                    };

                    log('ä½¿ç”¨AudioWorkletå¤„ç†éŸ³é¢‘', 'success');
                    return { node: audioProcessor, type: 'worklet' };
                } else {
                    // ä½¿ç”¨æ—§ç‰ˆScriptProcessorNodeä½œä¸ºå›é€€æ–¹æ¡ˆ
                    log('AudioWorkletä¸å¯ç”¨ï¼Œä½¿ç”¨ScriptProcessorNodeä½œä¸ºå›é€€æ–¹æ¡ˆ', 'warning');

                    const frameSize = 4096; // ScriptProcessorNodeç¼“å†²åŒºå¤§å°
                    const scriptProcessor = audioContext.createScriptProcessor(frameSize, 1, 1);

                    // å°†audioProcessäº‹ä»¶è®¾ç½®ä¸ºå¤„ç†éŸ³é¢‘æ•°æ®
                    scriptProcessor.onaudioprocess = (event) => {
                        if (!isRecording) return;

                        const input = event.inputBuffer.getChannelData(0);
                        const buffer = new Int16Array(input.length);

                        // å°†æµ®ç‚¹æ•°æ®è½¬æ¢ä¸º16ä½æ•´æ•°
                        for (let i = 0; i < input.length; i++) {
                            buffer[i] = Math.max(-32768, Math.min(32767, Math.floor(input[i] * 32767)));
                        }

                        // å¤„ç†PCMæ•°æ®
                        processPCMBuffer(buffer);
                    };

                    // éœ€è¦è¿æ¥è¾“å‡ºï¼Œå¦åˆ™ä¸ä¼šè§¦å‘å¤„ç†
                    // æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé™éŸ³é€šé“
                    const silent = audioContext.createGain();
                    silent.gain.value = 0;
                    scriptProcessor.connect(silent);
                    silent.connect(audioContext.destination);

                    return { node: scriptProcessor, type: 'processor' };
                }
            } catch (error) {
                log(`åˆ›å»ºéŸ³é¢‘å¤„ç†å™¨å¤±è´¥: ${error.message}ï¼Œå°è¯•å›é€€æ–¹æ¡ˆ`, 'error');

                // æœ€åå›é€€æ–¹æ¡ˆï¼šä½¿ç”¨ScriptProcessorNode
                try {
                    const frameSize = 4096; // ScriptProcessorNodeç¼“å†²åŒºå¤§å°
                    const scriptProcessor = audioContext.createScriptProcessor(frameSize, 1, 1);

                    scriptProcessor.onaudioprocess = (event) => {
                        if (!isRecording) return;

                        const input = event.inputBuffer.getChannelData(0);
                        const buffer = new Int16Array(input.length);

                        for (let i = 0; i < input.length; i++) {
                            buffer[i] = Math.max(-32768, Math.min(32767, Math.floor(input[i] * 32767)));
                        }

                        processPCMBuffer(buffer);
                    };

                    const silent = audioContext.createGain();
                    silent.gain.value = 0;
                    scriptProcessor.connect(silent);
                    silent.connect(audioContext.destination);

                    log('ä½¿ç”¨ScriptProcessorNodeä½œä¸ºå›é€€æ–¹æ¡ˆæˆåŠŸ', 'warning');
                    return { node: scriptProcessor, type: 'processor' };
                } catch (fallbackError) {
                    log(`å›é€€æ–¹æ¡ˆä¹Ÿå¤±è´¥: ${fallbackError.message}`, 'error');
                    return null;
                }
            }
        }

        // åˆå§‹åŒ–ç›´æ¥ä»PCMæ•°æ®å½•éŸ³çš„ç³»ç»Ÿ
        let audioProcessor = null;
        let audioProcessorType = null;
        let audioSource = null;

        // å¤„ç†PCMç¼“å†²æ•°æ®
        let pcmDataBuffer = new Int16Array();
        function processPCMBuffer(buffer) {
            if (!isRecording) return;

            // å°†æ–°çš„PCMæ•°æ®è¿½åŠ åˆ°ç¼“å†²åŒº
            const newBuffer = new Int16Array(pcmDataBuffer.length + buffer.length);
            newBuffer.set(pcmDataBuffer);
            newBuffer.set(buffer, pcmDataBuffer.length);
            pcmDataBuffer = newBuffer;

            // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ•°æ®è¿›è¡ŒOpusç¼–ç ï¼ˆ16000Hz, 60ms = 960ä¸ªé‡‡æ ·ç‚¹ï¼‰
            const samplesPerFrame = 960; // 60ms @ 16kHz

            while (pcmDataBuffer.length >= samplesPerFrame) {
                // ä»ç¼“å†²åŒºå–å‡ºä¸€å¸§æ•°æ®
                const frameData = pcmDataBuffer.slice(0, samplesPerFrame);
                pcmDataBuffer = pcmDataBuffer.slice(samplesPerFrame);

                // ç¼–ç ä¸ºOpus
                encodeAndSendOpus(frameData);
            }
        }

        // ç¼–ç å¹¶å‘é€Opusæ•°æ®
        function encodeAndSendOpus(pcmData = null) {
            if (!opusEncoder) {
                log('Opusç¼–ç å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }

            try {
                // å¦‚æœæä¾›äº†PCMæ•°æ®ï¼Œåˆ™ç¼–ç è¯¥æ•°æ®
                if (pcmData) {
                    // ä½¿ç”¨å·²åˆå§‹åŒ–çš„Opusç¼–ç å™¨ç¼–ç 
                    const opusData = opusEncoder.encode(pcmData);

                    if (opusData && opusData.length > 0) {
                        // å­˜å‚¨éŸ³é¢‘å¸§
                        audioBuffers.push(opusData.buffer);
                        totalAudioSize += opusData.length;

                        // å¦‚æœWebSocketå·²è¿æ¥ï¼Œåˆ™å‘é€æ•°æ®
                        if (websocket && websocket.readyState === WebSocket.OPEN) {
                            try {
                                // æœåŠ¡ç«¯æœŸæœ›æ¥æ”¶åŸå§‹Opusæ•°æ®ï¼Œä¸éœ€è¦ä»»ä½•é¢å¤–åŒ…è£…
                                websocket.send(opusData.buffer);
                                log(`å‘é€Opuså¸§ï¼Œå¤§å°ï¼š${opusData.length}å­—èŠ‚`, 'debug');
                            } catch (error) {
                                log(`WebSocketå‘é€é”™è¯¯: ${error.message}`, 'error');
                            }
                        }
                    } else {
                        log('Opusç¼–ç å¤±è´¥ï¼Œæ— æœ‰æ•ˆæ•°æ®è¿”å›', 'error');
                    }
                } else {
                    // å¤„ç†å‰©ä½™çš„PCMæ•°æ®
                    if (pcmDataBuffer.length > 0) {
                        // å¦‚æœå‰©ä½™çš„é‡‡æ ·ç‚¹ä¸è¶³ä¸€å¸§ï¼Œç”¨é™éŸ³å¡«å……
                        const samplesPerFrame = 960;
                        if (pcmDataBuffer.length < samplesPerFrame) {
                            const paddedBuffer = new Int16Array(samplesPerFrame);
                            paddedBuffer.set(pcmDataBuffer);
                            // å‰©ä½™éƒ¨åˆ†ä¸º0ï¼ˆé™éŸ³ï¼‰
                            encodeAndSendOpus(paddedBuffer);
                        } else {
                            encodeAndSendOpus(pcmDataBuffer.slice(0, samplesPerFrame));
                        }
                        pcmDataBuffer = new Int16Array(0);
                    }
                }
            } catch (error) {
                log(`Opusç¼–ç é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // å¼€å§‹ç›´æ¥ä»PCMæ•°æ®å½•éŸ³
        async function startDirectRecording() {
            if (isRecording) return;

            try {
                // åˆå§‹åŒ–Opusç¼–ç å™¨
                if (!initOpusEncoder()) {
                    log('æ— æ³•å¯åŠ¨å½•éŸ³: Opusç¼–ç å™¨åˆå§‹åŒ–å¤±è´¥', 'error');
                    return;
                }

                // è¯·æ±‚éº¦å…‹é£æƒé™
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000,
                        channelCount: 1
                    }
                });

                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡å’Œåˆ†æå™¨
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 16000,
                        latencyHint: 'interactive'
                    });
                }

                // åˆ›å»ºéŸ³é¢‘å¤„ç†å™¨
                const processorResult = await createAudioProcessor();
                if (!processorResult) {
                    log('æ— æ³•åˆ›å»ºéŸ³é¢‘å¤„ç†å™¨', 'error');
                    return;
                }

                audioProcessor = processorResult.node;
                audioProcessorType = processorResult.type;

                // è¿æ¥éŸ³é¢‘å¤„ç†é“¾
                audioSource = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;

                audioSource.connect(analyser);
                audioSource.connect(audioProcessor);

                // å¯åŠ¨å½•éŸ³
                pcmDataBuffer = new Int16Array();
                audioBuffers = [];
                totalAudioSize = 0;
                isRecording = true;

                // å¯åŠ¨éŸ³é¢‘å¤„ç†å™¨çš„å½•éŸ³ - åªæœ‰AudioWorkletæ‰éœ€è¦å‘é€æ¶ˆæ¯
                if (audioProcessorType === 'worklet' && audioProcessor.port) {
                    audioProcessor.port.postMessage({ command: 'start' });
                }

                // å‘é€ç›‘å¬å¼€å§‹æ¶ˆæ¯
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    // ä½¿ç”¨ä¸æœåŠ¡ç«¯æœŸæœ›çš„listenæ¶ˆæ¯æ ¼å¼
                    const listenMessage = {
                        type: 'listen',
                        mode: 'manual',  // ä½¿ç”¨æ‰‹åŠ¨æ¨¡å¼ï¼Œç”±æˆ‘ä»¬æ§åˆ¶å¼€å§‹/åœæ­¢
                        state: 'start'   // è¡¨ç¤ºå¼€å§‹å½•éŸ³
                    };

                    log(`å‘é€å½•éŸ³å¼€å§‹æ¶ˆæ¯: ${JSON.stringify(listenMessage)}`, 'info');
                    websocket.send(JSON.stringify(listenMessage));
                } else {
                    log('WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€å¼€å§‹æ¶ˆæ¯', 'error');
                    return false;
                }

                // å¼€å§‹éŸ³é¢‘å¯è§†åŒ–
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                drawVisualizer(dataArray);

                // åœ¨UIä¸Šæ˜¾ç¤ºå½•éŸ³è®¡æ—¶å™¨
                let recordingSeconds = 0;
                const recordingTimer = setInterval(() => {
                    recordingSeconds += 0.1;
                    recordButton.innerHTML = `<span style="font-size: 0.7rem; line-height: 1.1;">åœæ­¢<br>${recordingSeconds.toFixed(1)}ç§’</span>`;
                }, 100);

                // ä¿å­˜è®¡æ—¶å™¨ï¼Œä»¥ä¾¿åœ¨åœæ­¢æ—¶æ¸…é™¤
                window.recordingTimer = recordingTimer;

                recordButton.classList.add('recording');
                recordButton.disabled = false;

                log('å¼€å§‹PCMç›´æ¥å½•éŸ³', 'success');
                return true;
            } catch (error) {
                log(`ç›´æ¥å½•éŸ³å¯åŠ¨é”™è¯¯: ${error.message}`, 'error');
                isRecording = false;
                return false;
            }
        }

        // åœæ­¢ç›´æ¥ä»PCMæ•°æ®å½•éŸ³
        function stopDirectRecording() {
            if (!isRecording) return;

            try {
                // åœæ­¢å½•éŸ³
                isRecording = false;

                // åœæ­¢éŸ³é¢‘å¤„ç†å™¨çš„å½•éŸ³
                if (audioProcessor) {
                    // åªæœ‰AudioWorkletæ‰éœ€è¦å‘é€åœæ­¢æ¶ˆæ¯
                    if (audioProcessorType === 'worklet' && audioProcessor.port) {
                        audioProcessor.port.postMessage({ command: 'stop' });
                    }

                    audioProcessor.disconnect();
                    audioProcessor = null;
                }

                // æ–­å¼€éŸ³é¢‘è¿æ¥
                if (audioSource) {
                    audioSource.disconnect();
                    audioSource = null;
                }

                // åœæ­¢å¯è§†åŒ–
                if (visualizationRequest) {
                    cancelAnimationFrame(visualizationRequest);
                    visualizationRequest = null;
                }

                // æ¸…é™¤å½•éŸ³è®¡æ—¶å™¨
                if (window.recordingTimer) {
                    clearInterval(window.recordingTimer);
                    window.recordingTimer = null;
                }

                // ç¼–ç å¹¶å‘é€å‰©ä½™çš„æ•°æ®
                encodeAndSendOpus();

                // å‘é€ä¸€ä¸ªç©ºçš„æ¶ˆæ¯ä½œä¸ºç»“æŸæ ‡å¿—ï¼ˆæ¨¡æ‹Ÿæ¥æ”¶åˆ°ç©ºéŸ³é¢‘æ•°æ®çš„æƒ…å†µï¼‰
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    // ä½¿ç”¨ç©ºçš„Uint8Arrayå‘é€æœ€åä¸€ä¸ªç©ºå¸§
                    const emptyOpusFrame = new Uint8Array(0);
                    websocket.send(emptyOpusFrame);

                    // å‘é€ç›‘å¬ç»“æŸæ¶ˆæ¯
                    const stopMessage = {
                        type: 'listen',
                        mode: 'manual',
                        state: 'stop'
                    };

                    websocket.send(JSON.stringify(stopMessage));
                    log('å·²å‘é€å½•éŸ³åœæ­¢ä¿¡å·', 'info');
                }

                // é‡ç½®UI
                recordButton.innerHTML = '<span style="font-size: 0.75rem;">å¼€å§‹</span>';
                recordButton.classList.remove('recording');
                recordButton.disabled = false;

                log('åœæ­¢PCMç›´æ¥å½•éŸ³', 'success');
                return true;
            } catch (error) {
                log(`ç›´æ¥å½•éŸ³åœæ­¢é”™è¯¯: ${error.message}`, 'error');
                return false;
            }
        }

        async function handleBinaryMessage(data) {
            try {
                let arrayBuffer;

                // æ ¹æ®æ•°æ®ç±»å‹è¿›è¡Œå¤„ç†
                if (data instanceof ArrayBuffer) {
                    arrayBuffer = data;
                    log(`æ”¶åˆ°ArrayBufferéŸ³é¢‘æ•°æ®ï¼Œå¤§å°: ${data.byteLength}å­—èŠ‚`, 'debug');
                } else if (data instanceof Blob) {
                    // å¦‚æœæ˜¯Blobç±»å‹ï¼Œè½¬æ¢ä¸ºArrayBuffer
                    arrayBuffer = await data.arrayBuffer();
                    log(`æ”¶åˆ°BlobéŸ³é¢‘æ•°æ®ï¼Œå¤§å°: ${arrayBuffer.byteLength}å­—èŠ‚`, 'debug');
                } else {
                    log(`æ”¶åˆ°æœªçŸ¥ç±»å‹çš„äºŒè¿›åˆ¶æ•°æ®: ${typeof data}`, 'warning');
                    return;
                }

                // åˆ›å»ºUint8Arrayç”¨äºå¤„ç†
                const opusData = new Uint8Array(arrayBuffer);

                if (opusData.length > 0) {
                    // æ£€æŸ¥å½“å‰è¾“å…¥æ¨¡å¼ï¼Œåªæœ‰åœ¨è¯­éŸ³è¾“å…¥æ¨¡å¼ä¸‹æ‰å¤„ç†éŸ³é¢‘æ•°æ®
                    const currentMode = getCurrentInputMode();
                    if (currentMode === 'voice') {
                        // å°†æ•°æ®æ·»åŠ åˆ°ç¼“å†²é˜Ÿåˆ—
                        audioBufferQueue.push(opusData);

                        // å¦‚æœæ”¶åˆ°çš„æ˜¯ç¬¬ä¸€ä¸ªéŸ³é¢‘åŒ…ï¼Œå¼€å§‹ç¼“å†²è¿‡ç¨‹
                        if (audioBufferQueue.length === 1 && !isAudioBuffering && !isAudioPlaying) {
                            startAudioBuffering();
                        }
                    } else {
                        // æ–‡æœ¬è¾“å…¥æ¨¡å¼ä¸‹å¿½ç•¥éŸ³é¢‘æ•°æ®
                        log('æ–‡æœ¬è¾“å…¥æ¨¡å¼ï¼Œå¿½ç•¥éŸ³é¢‘æ•°æ®', 'debug');
                    }
                } else {
                    log('æ”¶åˆ°ç©ºéŸ³é¢‘æ•°æ®å¸§ï¼Œå¯èƒ½æ˜¯ç»“æŸæ ‡å¿—', 'warning');

                    // å¦‚æœç¼“å†²é˜Ÿåˆ—ä¸­æœ‰æ•°æ®ä¸”æ²¡æœ‰åœ¨æ’­æ”¾ï¼Œæ£€æŸ¥å½“å‰è¾“å…¥æ¨¡å¼åå†³å®šæ˜¯å¦æ’­æ”¾
                    if (audioBufferQueue.length > 0 && !isAudioPlaying) {
                        const currentMode = getCurrentInputMode();
                        if (currentMode === 'voice') {
                            playBufferedAudio();
                        } else {
                            log('æ–‡æœ¬è¾“å…¥æ¨¡å¼ï¼Œæš‚åœéŸ³é¢‘æ’­æ”¾', 'info');
                        }
                    }

                    // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œå‘é€ç»“æŸä¿¡å·
                    if (isAudioPlaying && streamingContext) {
                        streamingContext.endOfStream = true;
                    }
                }
            } catch (error) {
                log(`å¤„ç†äºŒè¿›åˆ¶æ¶ˆæ¯å‡ºé”™: ${error.message}`, 'error');
            }
        }

        // è·å–é…ç½®å€¼
        function getConfig() {
            const deviceMac = document.getElementById('deviceMac').value.trim();
            return {
                deviceId: deviceMac,  // ä½¿ç”¨MACåœ°å€ä½œä¸ºdeviceId
                deviceName: document.getElementById('deviceName').value.trim(),
                deviceMac: deviceMac,
                clientId: document.getElementById('clientId').value.trim(),
                token: document.getElementById('token').value.trim()
            };
        }

        // éªŒè¯é…ç½®
        function validateConfig(config) {
            if (!config.deviceMac) {
                log('è®¾å¤‡MACåœ°å€ä¸èƒ½ä¸ºç©º', 'error');
                return false;
            }
            if (!config.clientId) {
                log('å®¢æˆ·ç«¯IDä¸èƒ½ä¸ºç©º', 'error');
                return false;
            }
            return true;
        }

        initApp();

        // åŠ¨æ€è°ƒæ•´è§†å£é«˜åº¦ï¼Œè§£å†³ç§»åŠ¨ç«¯æµè§ˆå™¨åœ°å€æ é—®é¢˜
        function setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        // åˆå§‹è®¾ç½®
        setViewportHeight();

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', () => {
            setTimeout(setViewportHeight, 100);
        });

        // ç§»åŠ¨ç«¯ç‰¹æ®Šå¤„ç†
        if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            // ç›‘å¬è™šæ‹Ÿé”®ç›˜æ˜¾ç¤º/éšè—
            window.addEventListener('resize', () => {
                setTimeout(() => {
                    setViewportHeight();
                    // ç¡®ä¿èŠå¤©åŒºåŸŸä¸è¢«é®æŒ¡
                    const conversationArea = document.getElementById('conversationArea');
                    if (conversationArea) {
                        conversationArea.scrollTop = conversationArea.scrollHeight;
                    }
                }, 150);
            });
        }



    </script>

<!-- åº•éƒ¨å¯¼èˆªæ  -->
<div class="bottom-nav">
    <div class="nav-item" data-target="index">
        <div class="nav-icon">
            <i class="fas fa-home"></i>
        </div>
        <div class="nav-label">ä¸»é¡µ</div>
    </div>
    <div class="nav-item" data-target="orders">
        <div class="nav-icon">
            <i class="fas fa-utensils"></i>
        </div>
        <div class="nav-label">ç‚¹é¤</div>
    </div>
    <div class="nav-item" data-target="repo">
        <div class="nav-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="nav-label">æŠ¥å‘Š</div>
    </div>
    <div class="nav-item active" data-target="ai-assistant">
        <div class="nav-icon">
            <i class="fas fa-robot"></i>
        </div>
        <div class="nav-label">AIåŠ©æ‰‹</div>
    </div>
</div>

<script>
    // åº•éƒ¨å¯¼èˆªç‚¹å‡»è·³è½¬
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function () {
            const target = this.getAttribute('data-target');
            let targetUrl = '';
            switch (target) {
                case 'index':
                    targetUrl = "/";
                    break;
                case 'orders':
                    targetUrl = "/orders/";
                    break;
                case 'repo':
                    targetUrl = "/repo/";
                    break;
                case 'ai-assistant':
                    targetUrl = "/ai_health_advisor/";
                    break;
            }
            if (targetUrl) {
                window.location.href = targetUrl;
            }
        });
    });
</script>

        <div class="top-header">
            <div class="header-left">
                <div class="header-logo"><i class="fas fa-robot"></i></div>
                <div class="header-title">AIå¥åº·é¡¾é—®</div>
            </div>
            <div class="header-right">
                <div class="header-icon" onclick="document.querySelector('.settings-panel').classList.toggle('open')">
                    <i class="fas fa-cog"></i>
                </div>
            </div>
        </div>
</body>

</html>
